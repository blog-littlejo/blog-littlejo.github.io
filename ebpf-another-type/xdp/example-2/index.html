<!doctype html><html lang=fr dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="fr"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Att√©nuons les attaques DDoS avec XDP &#183; Le blog de Little Jo</title><meta name=title content="Att√©nuons les attaques DDoS avec XDP &#183; Le blog de Little Jo"><meta name=description content="Regardons comment limiter le d√©ni de service avec XDP"><meta name=keywords content="Rust,eBPF,aya,xdp,"><link rel=canonical href=https://blog.littlejo.link/ebpf-another-type/xdp/example-2/><meta name=author content="Joseph Ligier"><link href=https://bsky.app/profile/littlejo.bsky.social rel=me><link href=https://www.linkedin.com/in/joseph-ligier-4b86632 rel=me><link href=https://dev.to/littlejo rel=me><link href=https://medium.com/@littel.jo rel=me><link href=https://github.com/littlejo rel=me><link href=https://ko-fi.com/littlejo rel=me><meta property="og:url" content="https://blog.littlejo.link/ebpf-another-type/xdp/example-2/"><meta property="og:site_name" content="Le blog de Little Jo"><meta property="og:title" content="Att√©nuons les attaques DDoS avec XDP"><meta property="og:description" content="Regardons comment limiter le d√©ni de service avec XDP"><meta property="og:locale" content="fr"><meta property="og:type" content="article"><meta property="article:section" content="ebpf-another-type"><meta property="article:published_time" content="2025-11-24T10:38:28+01:00"><meta property="article:modified_time" content="2025-11-24T10:38:28+01:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="EBPF"><meta property="article:tag" content="Aya"><meta property="article:tag" content="Xdp"><meta property="og:image" content="https://blog.littlejo.link/ebpf-another-type/xdp/example-2/featured.webp"><meta property="og:see_also" content="https://blog.littlejo.link/ebpf-another-type/xdp/example-3-tr/"><meta property="og:see_also" content="https://blog.littlejo.link/ebpf-another-type/xdp/example-1/"><meta property="og:see_also" content="https://blog.littlejo.link/ebpf-another-type/xdp/intro/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.littlejo.link/ebpf-another-type/xdp/example-2/featured.webp"><meta name=twitter:title content="Att√©nuons les attaques DDoS avec XDP"><meta name=twitter:description content="Regardons comment limiter le d√©ni de service avec XDP"><link type=text/css rel=stylesheet href=/css/main.bundle.min.b40b1ed6cd8b0f0b23d4e4d8d2cc52d50cc15b8e9d2c4b8e19a08fb960c4035326895dbbda305c98701405a07ac803e772fce0015b40d6e84c118999062b9ac3.css integrity="sha512-tAse1s2LDwsj1OTY0sxS1QzBW46dLEuOGaCPuWDEA1MmiV272jBcmHAUBaB6yAPncvzgAVtA1uhMEYmZBiuaww=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script type=text/javascript src=/js/zen-mode.min.9814dee9614d32aeb56239d118edfe20acd6231424f9b19c2dd48835038414130a5e946c0d1c9087d60e60e31840c9babfd217e3d4b95643dc8d651a71ccdf4a.js integrity="sha512-mBTe6WFNMq61YjnRGO3+IKzWIxQk+bGcLdSINQOEFBMKXpRsDRyQh9YOYOMYQMm6v9IX49S5VkPcjWUacczfSg=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9cc802d09f28c6af56ceee7bc6e320a39251fdae98243f2a9942f221ac57a9f49c51609699a91794a7b2580ee1deaa8e4d794a68ffa94aa317c66e893ce51e02.js integrity="sha512-nMgC0J8oxq9Wzu57xuMgo5JR/a6YJD8qmULyIaxXqfScUWCWmakXlKeyWA7h3qqOTXlKaP+pSqMXxm6JPOUeAg==" data-copy=Copier data-copied=Copi√©></script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Ebpf-Another-Types","name":"Att√©nuons les attaques DDoS avec XDP","headline":"Att√©nuons les attaques DDoS avec XDP","description":"Regardons comment limiter le d√©ni de service avec XDP","abstract":"Regardons comment limiter le d√©ni de service avec XDP","inLanguage":"fr","url":"https:\/\/blog.littlejo.link\/ebpf-another-type\/xdp\/example-2\/","author":{"@type":"Person","name":"Joseph Ligier"},"copyrightYear":"2025","dateCreated":"2025-11-24T10:38:28\u002b01:00","datePublished":"2025-11-24T10:38:28\u002b01:00","dateModified":"2025-11-24T10:38:28\u002b01:00","keywords":["Rust","eBPF","aya","xdp"],"mainEntityOfPage":"true","wordCount":"3140"}]</script><script data-goatcounter=https://littlejo-prd.goatcounter.com/count async src=/js/count.js></script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Aller au contenu</a></div><div class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium">Le blog de Little Jo</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/categories/introduction/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=Blog title=Introduction><p class="text-base font-medium">Blog</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium hover:text-primary-600 dark:hover:text-primary-400" title="Att√©nuons les attaques DDoS avec XDP">FR</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/ebpf-another-type/xdp/example-2/ class="flex items-center"><p class="text-sm font-sm hover:text-primary-600 dark:hover:text-primary-400" title="Att√©nuons les attaques DDoS avec XDP">FR</p></a><a href=/en/ebpf-another-type/xdp/example-2/ class="flex items-center"><p class="text-sm font-sm hover:text-primary-600 dark:hover:text-primary-400" title="Let's Mitigate DDoS Attacks with XDP">EN</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Rechercher (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span><div><div class="cursor-pointer flex items-center nested-menu"><span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium hover:text-primary-600 dark:hover:text-primary-400" title="Att√©nuons les attaques DDoS avec XDP">FR</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/ebpf-another-type/xdp/example-2/ class="flex items-center"><p class="text-sm font-sm hover:text-primary-600 dark:hover:text-primary-400" title="Att√©nuons les attaques DDoS avec XDP">FR</p></a><a href=/en/ebpf-another-type/xdp/example-2/ class="flex items-center"><p class="text-sm font-sm hover:text-primary-600 dark:hover:text-primary-400" title="Let's Mitigate DDoS Attacks with XDP">EN</p></a></div></div></div></div><button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Rechercher (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 me-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/categories/introduction/ class="flex items-center hover:text-primary-600 dark:hover:text-primary-400" aria-label=Blog title=Introduction><p class="text-bg font-bg">Blog</p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/ebpf-another-type/xdp/example-2/featured_hu_7e4620a81e6b46a6.webp alt="Att√©nuons les attaques DDoS avec XDP" loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url=/ebpf-another-type/xdp/example-2/featured_hu_7e4620a81e6b46a6.webp></script><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Le blog de Little Jo</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/ebpf-another-type/>Ebpf-Another-Types</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/ebpf-another-type/xdp/example-2/>Att√©nuons les attaques DDoS avec XDP</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Att√©nuons les attaques DDoS avec XDP</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-11-24T10:38:28+01:00>24 novembre 2025</time><span class="px-2 text-primary-500">&#183;</span><span>3140 mots</span><span class="px-2 text-primary-500">&#183;</span><span title="Temps de lecture">15 mins</span><span class="px-2 text-primary-500">&#183;</span><span class=mb-[2px]>
<span id=zen-mode-button class="text-lg hover:text-primary-500" title="Activer le mode zen" data-title-i18n-disable="Activer le mode zen" data-title-i18n-enable="D√©sactiver le mode zen"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentColor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4" width=96 height=96 alt="Joseph Ligier" src=/img/littlejo_hu_4250d52962eec5b0.jpg data-zoom-src=/img/littlejo.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Auteur</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Joseph Ligier</div><div class="text-sm text-neutral-700 dark:text-neutral-400">CNCF ambassador | Kubestronaut üêù</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://bsky.app/profile/littlejo.bsky.social target=_blank aria-label=Bluesky title=Bluesky rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/joseph-ligier-4b86632 target=_blank aria-label=Linkedin title=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://dev.to/littlejo target=_blank aria-label=Dev title=Dev rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88.0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59.0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21.0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44.0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44.0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://medium.com/@littel.jo target=_blank aria-label=Medium title=Medium rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M180.5 74.262C80.813 74.262.0 155.633.0 256S80.819 437.738 180.5 437.738 361 356.373 361 256 280.191 74.262 180.5 74.262zm288.25 10.646c-49.845.0-90.245 76.619-90.245 171.095s40.406 171.1 90.251 171.1 90.251-76.619 90.251-171.1H559C559 161.5 518.6 84.908 468.752 84.908zm139.506 17.821c-17.526.0-31.735 68.628-31.735 153.274s14.2 153.274 31.735 153.274S640 340.631 640 256c0-84.649-14.215-153.271-31.742-153.271z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/littlejo target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://ko-fi.com/littlejo target=_blank aria-label=Ko-Fi title=Ko-Fi rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg width="211.67mm" height="211.67mm" viewBox="0 0 211.67 211.67"><defs><clipPath id="clipPath25"><path d="m0 6e2h1654.8V0H0z" fill="currentColor"/></clipPath></defs><g transform="translate(-3.0786 -29.59)"><g transform="matrix(.35278 0 0 -.35278 3.0785 241.26)"><g clip-path="url(#clipPath25)"><g transform="translate(600 300)"><path d="m-3e2 3e2c-165.69.0-3e2-134.31-3e2-3e2s134.31-3e2 3e2-3e2C-134.32-3e2.0-165.69.0.0s-134.32 3e2-3e2 3e2zm-188.93-166.99h329.58c23.223.0 46.032-6.8325 65.073-20.125 18.412-12.856 36.378-33.646 42.697-67.02 14.674-77.514-43.568-135.76-126.12-131.18.438-21.268-3.8105-59.422-44.878-69.696-3.282-.821-6.6604-1.186-10.044-1.207-72.13-.448-222.53-.88916-222.53-.88916s-46.066-.01555-49.176 45.962c-1.023 77.88-.48339 223.69-.48339 223.69s-.02651 2.9267-.02051 3.6577c.043 5.607 4.4359 16.8 15.901 16.8zm312.71-55.573v-107.8s14.302-1.6507 31.907.54932c20.356 6.6 39.06 20.901 39.06 57.199.0 14.85-5.2614 25.601-11.837 33.239-9.341 10.848-23.152 16.809-37.469 16.809h-21.661z" fill="currentColor"/></g><g transform="translate(256.61 203.37)"><path d="m0 0c3.585-1.806 5.876.437 5.876.437s52.457 47.878 76.089 75.452c21.018 24.667 22.389 66.234-13.708 81.766-36.096 15.532-65.795-18.272-65.795-18.272-25.755 28.326-64.734 26.891-82.763 7.721-18.027-19.169-11.732-52.072 1.717-70.383 12.626-17.19 68.119-66.65 76.529-75.015.0.0.614-.641 2.055-1.706" fill="currentColor"/></g></g></g></g></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Sommaire</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#cr√©ons-un-petit-tcpdump-avec-xdp>Cr√©ons un petit <code>tcpdump</code> avec XDP</a><ul><li><a href=#les-connexions-tcp>Les connexions TCP</a></li><li><a href=#quest-ce-que-le-syn-flood->Qu&rsquo;est-ce que le SYN Flood ?</a></li><li><a href=#comment-voir-les-d√©tails-des-segments>Comment voir les d√©tails des segments</a></li></ul></li><li><a href=#essayons-datt√©nuer-les-attaques-syn-flood>Essayons d&rsquo;att√©nuer les attaques SYN flood</a><ul><li><a href=#token-bucket>Token Bucket</a></li><li><a href=#comment-limpl√©menter-dans-ebpf->Comment l&rsquo;impl√©menter dans eBPF ?</a></li></ul></li><li><a href=#repassons-au-code>Repassons au code</a><ul><li><a href=#d√©cr√©mentation-de-la-map-bucket>D√©cr√©mentation de la map Bucket</a></li><li><a href=#calcul-du-rajout-des-jetons>Calcul du rajout des jetons</a></li><li><a href=#limite-du-programme>Limite du programme</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Sommaire</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#cr√©ons-un-petit-tcpdump-avec-xdp>Cr√©ons un petit <code>tcpdump</code> avec XDP</a><ul><li><a href=#les-connexions-tcp>Les connexions TCP</a></li><li><a href=#quest-ce-que-le-syn-flood->Qu&rsquo;est-ce que le SYN Flood ?</a></li><li><a href=#comment-voir-les-d√©tails-des-segments>Comment voir les d√©tails des segments</a></li></ul></li><li><a href=#essayons-datt√©nuer-les-attaques-syn-flood>Essayons d&rsquo;att√©nuer les attaques SYN flood</a><ul><li><a href=#token-bucket>Token Bucket</a></li><li><a href=#comment-limpl√©menter-dans-ebpf->Comment l&rsquo;impl√©menter dans eBPF ?</a></li></ul></li><li><a href=#repassons-au-code>Repassons au code</a><ul><li><a href=#d√©cr√©mentation-de-la-map-bucket>D√©cr√©mentation de la map Bucket</a></li><li><a href=#calcul-du-rajout-des-jetons>Calcul du rajout des jetons</a></li><li><a href=#limite-du-programme>Limite du programme</a></li></ul></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!1,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details class="mt-2 mb-5 overflow-hidden rounded-lg ms-0 ps-5" open><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 -ms-5 ps-5 dark:bg-primary-800 dark:text-neutral-100">Apprenons XDP avec Aya -
Cet article fait partie d'une s√©rie.</summary><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/ebpf-another-type/xdp/intro/>Partie 1:
XDP, le firewall ultra rapide de Linux</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/ebpf-another-type/xdp/example-1/>Partie 2:
Impl√©mentons un petit firewall avec XDP</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">Partie 3:
Cet article</div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/ebpf-another-type/xdp/example-3-tr/>Partie 4:
Cr√©ons un petit load balancer avec XDP</a></div></details><div class="article-content max-w-prose mb-20"><p>Nous avons vu ce qu&rsquo;√©tait un programme XDP dans <a href=/ebpf-another-type/xdp/intro/>la premi√®re partie</a> : cela peut √™tre un moyen de limiter les attaques par d√©ni de service distribu√©.</p><p>Dans cette partie, je vous propose de cr√©er un programme XDP qui va limiter les attaques par <em>SYN flood</em>. On va faire cela avec le framework Rust Aya.</p><p>Suivez le guide !</p><div class="flex px-4 py-3 rounded-md
alert-tip"><span class="pe-3 flex items-center
alert-icon-tip"><span class="relative block icon"><svg fill="currentColor" width="800" height="800" viewBox="-2 -2 36 36"><title>lab</title><path d="M19.332 19.041s-1.664 2.125-3.79.0c-2.062-2-3.562.0-3.562.0l-4.967 9.79c-.144.533.173 1.081.706 1.224h16.497c.533-.143.85-.69.707-1.224l-5.591-9.79zm7.607 9.289-7.979-13.428v-.025l-.014-7.869h.551c.826.0 1.498-.671 1.498-1.499.0-.827-.672-1.498-1.498-1.498h-7.995c-.827.0-1.498.671-1.498 1.498.0.828.671 1.499 1.498 1.499h.482l-.016 7.871L5.06 28.33c-.428 1.599.521 3.242 2.119 3.67H24.82c1.6-.428 2.549-2.071 2.119-3.67zm-2.386 2.668-17.108-.019c-1.065-.286-1.697-1.382-1.412-2.446l6.947-13.616.021-8.908h-1.498c-.275.0-.499-.224-.499-.5s.224-.499.499-.499h7.995c.275.0.498.224.498.499.0.276-.223.5-.498.5H18l.025 8.875 7.939 13.666c.286 1.067-.347 2.163-1.411 2.448zM16.48 2.512c0 .552.448 1 1 1s1-.448 1-1-.447-1-1-1-1 .447-1 1zm-3 0c.553.0 1-.448 1-1s-.447-1-1-1-1 .448-1 1 .447 1 1 1z"/></svg>
</span></span><span class=dark:text-neutral-300><p>Je suppose que vous √™tes d√©j√† dans un <a href=https://aya-rs.dev/book/start/development/ target=_blank>environnement pour d√©velopper avec Aya</a>.
Si ce n&rsquo;est pas le cas, vous pouvez utiliser le lab Killercoda :</p><p><a href=https://killercoda.com/littlejo/course/aya-prod/aya-xdp target=_blank><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Killer coda screenshot" src=https://blog.littlejo.link/assets/screenshot/xdp/killercoda.webp></figure></a></p></span></div><hr><h2 class="relative group">Cr√©ons un petit <code>tcpdump</code> avec XDP<div id=cr√©ons-un-petit-tcpdump-avec-xdp class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#cr%c3%a9ons-un-petit-tcpdump-avec-xdp aria-label=Ancre>#</a></span></h2><p>Avant de faire cela, nous allons d√©j√† expliquer comment on analyse un segment TCP avec XDP et ainsi r√©cup√©rer les paquets <em>SYN</em>. Au fait, vous vous rappelez comment fonctionne TCP ?</p><h3 class="relative group">Les connexions TCP<div id=les-connexions-tcp class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#les-connexions-tcp aria-label=Ancre>#</a></span></h3><p>TCP est l&rsquo;acronyme de <em><strong>T</strong>ransmission <strong>C</strong>ontrol <strong>P</strong>rotocol</em>. C&rsquo;est probablement le protocole r√©seau le plus utilis√© par les protocoles applicatifs : HTTP, SSH, etc. Difficile de faire l&rsquo;impasse pour des articles sur du r√©seau. Cependant c&rsquo;est probablement le plus complexe si on compare √† UDP ou √† ICMP.</p><p>Avant le t√©l√©chargement des donn√©es utiles, il y a une phase de connexion (<em>3-way handshake</em>) permettant d&rsquo;√©tablir un canal fiable.</p><p><object type=image/svg+xml data=https://blog.littlejo.link/assets/svg/xdp/tcp-connections.svg width=100%></object></p><h3 class="relative group">Qu&rsquo;est-ce que le SYN Flood ?<div id=quest-ce-que-le-syn-flood- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#quest-ce-que-le-syn-flood- aria-label=Ancre>#</a></span></h3><p><em>SYN</em> est le premier segment TCP qui sert √† initier une connexion TCP. Quand un serveur re√ßoit un <em>SYN</em>, il doit renvoyer un <em>SYN-ACK</em> pour accuser de r√©ception. Une fois cela, le client doit confirmer par un <em>ACK</em> et le t√©l√©chargement des donn√©es peut enfin op√©rer.</p><p>Supposons qu&rsquo;un client envoie une connexion <em>SYN</em> mais ne r√©pond jamais, que se passe-t-il ?</p><ul><li>Le serveur envoie un <em>SYN-ACK</em> en r√©ponse puis r√©essaie 5 fois (valeur par d√©faut)</li><li>Le serveur ferme enfin la connexion incompl√®te</li></ul><p><object type=image/svg+xml data=https://blog.littlejo.link/assets/svg/xdp/tcp-connections-syn.svg width=100%></object></p><p>Supposons qu&rsquo;un client innonde de plein de connexions <em>SYN</em> mais ne r√©pond jamais, que se passe-t-il ?</p><ul><li>Le serveur garde alors plein de connexions &ldquo;en attente&rdquo; (dont certain probablement l√©gitime)</li><li>Le serveur continue de renvoyer les <em>SYN-ACK</em> jusqu&rsquo;√† saturer ses ressources m√©moire</li></ul><p>C&rsquo;est √ßa le principe d&rsquo;une attaque <a href=https://fr.wikipedia.org/wiki/SYN_flood target=_blank>SYN Flood</a>.</p><p><object type=image/svg+xml data=https://blog.littlejo.link/assets/svg/xdp/tcp-connections-syn-flood.svg width=100%></object></p><p>Dans cet article, pour contrer cette attaque, on va compter le nombre de <em>SYN</em> par IP et s&rsquo;il y en a trop on bloque temporairement ces segments pour cette IP.</p><h3 class="relative group">Comment voir les d√©tails des segments<div id=comment-voir-les-d√©tails-des-segments class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#comment-voir-les-d%c3%a9tails-des-segments aria-label=Ancre>#</a></span></h3><p>Si ce n&rsquo;est pas d√©j√† fait, recr√©ons l&rsquo;environnement de d√©veloppement</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>git</span> clone https://github.com/littlejo/eunomia.dev
</span></span><span class=line><span class=cl><span class=k>cd</span> eunomia.dev/docs/tutorials/<span class=m>42</span>-xdp-loadbalancer/
</span></span><span class=line><span class=cl>./setup.sh
</span></span></code></pre></div><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=namepaces src=https://blog.littlejo.link/assets/svg/xdp/namespaces.svg></figure></p><p>D√©marrons un petit serveur web au niveau du namespace <code>lb</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>ip</span> netns <span class=nb>exec </span>lb python3 <span class=na>-m</span> http.server <span class=m>8080</span>
</span></span></code></pre></div><ul><li>Sur l&rsquo;interface <code>veth6</code>, nous verrons les paquets TCP qui sont envoy√©s par le client (comme <em>SYN</em>) ;</li><li>Sur l&rsquo;interface <code>veth7</code>, nous verrons les paquets TCP qui sont envoy√©s par le serveur (comme <em>SYN-ACK</em>).</li></ul><p>Nous devons donc installer le programme eBPF sur <code>veth6</code>.</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=namepaces src=https://blog.littlejo.link/assets/svg/xdp/namespaces-ddos-xdp.svg></figure></p><p>G√©n√©rons le programme Aya :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>cargo</span> generate <span class=na>--name</span> antiddos-xdp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               <span class=na>-d</span> <span class=nv>program_type</span><span class=o>=</span>xdp <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               <span class=na>-d</span> <span class=nv>default_iface</span><span class=o>=</span>veth6 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               <span class=nf>https</span>://github.com/aya-rs/aya-template
</span></span><span class=line><span class=cl><span class=k>cd</span> antiddos-xdp
</span></span></code></pre></div><p>En pr√©vision, nous allons utiliser des crates suppl√©mentaires :</p><ul><li><a href=https://docs.rs/aya-ebpf-bindings/latest/aya_ebpf_bindings/ target=_blank>aya-ebpf-bindings</a> pour les bindings suppl√©mentaires eBPF</li><li><a href=https://docs.rs/network-types/latest/network_types/index.html target=_blank>network-types</a> pour les structures Rust des en-t√™tes de niveau 1, 2 et 3</li><li><a href=https://github.com/littlejo/blog-xdp/ target=_blank>blog-xdp</a>, la crate de ce blog, pour ne pas copier/coller des fonctions helpers pr√©c√©demment √©crites</li></ul><p>On va donc modifier le fichier <code>antiddos-xdp-ebpf/Cargo.toml</code> et rajouter dans la section <em>dependencies</em> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Toml data-lang=Toml><span class=line><span class=cl><span class=nx>aya-ebpf-bindings</span> <span class=p>=</span> <span class=s2>&#34;0.1.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>network-types</span> <span class=p>=</span> <span class=s2>&#34;0.1.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>blog-xdp</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>git</span> <span class=p>=</span> <span class=s2>&#34;https://github.com/littlejo/blog-xdp&#34;</span> <span class=p>}</span>
</span></span></code></pre></div><p>V√©rifions que le programme g√©n√©r√© fonctionne bien :</p><p>On va d√©j√† construire le binaire :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>cargo</span> build
</span></span></code></pre></div><p>Puis on va installer dans le <em>namespace</em> cible o√π se trouve l&rsquo;interface <code>veth6</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>ip</span> netns <span class=nb>exec </span>lb cargo run
</span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-warning"><span class="pe-3 flex items-center
alert-icon-warning"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M266.3 48.3 232.5 73.6c-5.4 4-8.5 10.4-8.5 17.1v9.1c0 6.8 5.5 12.3 12.3 12.3 2.4.0 4.8-.7 6.8-2.1l41.8-27.9c2-1.3 4.4-2.1 6.8-2.1h1c6.2.0 11.3 5.1 11.3 11.3.0 3-1.2 5.9-3.3 8l-19.9 19.9c-5.8 5.8-12.9 10.2-20.7 12.8l-26.5 8.8c-5.8 1.9-9.6 7.3-9.6 13.4.0 3.7-1.5 7.3-4.1 10L202 182.1c-6.4 6.4-9.9 15-9.9 24v4.3c0 16.4 13.6 29.7 29.9 29.7 11 0 21.2-6.2 26.1-16l4-8.1c2.4-4.8 7.4-7.9 12.8-7.9 4.5.0 8.7 2.1 11.4 5.7l16.3 21.7c2.1 2.9 5.5 4.5 9.1 4.5 8.4.0 13.9-8.9 10.1-16.4l-1.1-2.3c-3.5-7 0-15.5 7.5-18l21.2-7.1c7.6-2.5 12.7-9.6 12.7-17.6.0-10.3 8.3-18.6 18.6-18.6H4e2c8.8.0 16 7.2 16 16s-7.2 16-16 16H379.3c-7.2.0-14.2 2.9-19.3 8l-4.7 4.7c-2.1 2.1-3.3 5-3.3 8 0 6.2 5.1 11.3 11.3 11.3h11.3c6 0 11.8 2.4 16 6.6l6.5 6.5c1.8 1.8 2.8 4.3 2.8 6.8s-1 5-2.8 6.8l-7.5 7.5C386 262 384 266.9 384 272s2 10 5.7 13.7L408 304c10.2 10.2 24.1 16 38.6 16H454c6.5-20.2 10-41.7 10-64 0-111.4-87.6-202.4-197.7-207.7zm172 307.9c-3.7-2.6-8.2-4.1-13-4.1-6 0-11.8-2.4-16-6.6L396 332c-7.7-7.7-18-12-28.9-12-9.7.0-19.2-3.5-26.6-9.8L314 287.4c-11.6-9.9-26.4-15.4-41.6-15.4h-21c-12.6.0-25 3.7-35.5 10.7L188.5 301c-17.8 11.9-28.5 31.9-28.5 53.3v3.2c0 17 6.7 33.3 18.7 45.3l16 16c8.5 8.5 20 13.3 32 13.3H248c13.3.0 24 10.7 24 24 0 2.5.4 5 1.1 7.3 71.3-5.8 132.5-47.6 165.2-107.2zM0 256a256 256 0 11512 0A256 256 0 110 256zM187.3 100.7c-6.2-6.2-16.4-6.2-22.6.0l-32 32c-6.2 6.2-6.2 16.4.0 22.6s16.4 6.2 22.6.0l32-32c6.2-6.2 6.2-16.4.0-22.6z"/></svg></span>
</span><span class=dark:text-neutral-300>Comme le <em>namespace</em> n&rsquo;a pas acc√®s √† Internet, il faut commencer par t√©l√©charger les crates pour les compiler au niveau du serveur puis installer le programme eBPF au niveau du namespace.</span></div><p>On va maintenant r√©cup√©rer uniquement les paquets TCP dans le programme eBPF. On va modifier le fichier <code>antiddos-xdp-ebpf/src/main.rs</code>.<figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=headers src=https://blog.littlejo.link/assets/svg/xdp/packet-headers-tcp.svg></figure></p><p>On se retrouve avec un code similaire au code de la <a href=/ebpf-another-type/xdp/example-1/>partie pr√©c√©dente</a> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>network_types</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>eth</span>::<span class=p>{</span><span class=n>EthHdr</span><span class=p>,</span><span class=w> </span><span class=n>EtherType</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ip</span>::<span class=p>{</span><span class=n>Ipv4Hdr</span><span class=p>,</span><span class=w> </span><span class=n>IpProto</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tcp</span>::<span class=n>TcpHdr</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>blog_xdp</span>::<span class=n>helper</span>::<span class=n>ptr_at</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>try_antiddos_xdp</span><span class=p>(</span><span class=n>ctx</span>: <span class=nc>XdpContext</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u32</span><span class=p>,</span><span class=w> </span><span class=kt>u32</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ethhdr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>EthHdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ptr_at</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>ethhdr</span><span class=p>).</span><span class=n>ether_type</span><span class=p>()</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>EtherType</span>::<span class=n>Ipv4</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ipv4hdr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>Ipv4Hdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ptr_at</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>EthHdr</span>::<span class=no>LEN</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>ipv4hdr</span><span class=p>).</span><span class=n>proto</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>IpProto</span>::<span class=n>Tcp</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>tcphdr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>TcpHdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ptr_at</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>EthHdr</span>::<span class=no>LEN</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Ipv4Hdr</span>::<span class=no>LEN</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>src_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>ipv4hdr</span><span class=p>).</span><span class=n>src_addr</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>dst_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>ipv4hdr</span><span class=p>).</span><span class=n>dst_addr</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;src:{:i} =&gt; dst:{:i}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>src_addr</span><span class=p>,</span><span class=w> </span><span class=n>dst_addr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>On peut tester que √ßa fonctionne :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>ip</span> netns <span class=nb>exec </span>lb cargo run
</span></span></code></pre></div><p>Verifions avec cette commande pour tester le programme XDP :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>curl</span> <span class=m>10</span>.<span class=m>0</span>.<span class=m>0</span>.<span class=m>10</span>:<span class=m>8080</span>
</span></span></code></pre></div><p>Au niveau de cargo, on voit alors plusieurs paquets pass√©s :</p><pre tabindex=0><code>[INFO  antiddos_xdp] src:10.0.0.1 =&gt; dst:10.0.0.10
[INFO  antiddos_xdp] src:10.0.0.1 =&gt; dst:10.0.0.10
[INFO  antiddos_xdp] src:10.0.0.1 =&gt; dst:10.0.0.10
[INFO  antiddos_xdp] src:10.0.0.1 =&gt; dst:10.0.0.10
[INFO  antiddos_xdp] src:10.0.0.1 =&gt; dst:10.0.0.10
[INFO  antiddos_xdp] src:10.0.0.1 =&gt; dst:10.0.0.10
</code></pre><p>Ce que j&rsquo;expliquais au d√©but, quand on lance une connexion TCP, il n&rsquo;y a pas qu&rsquo;un paquet mais plusieurs paquets.</p><p><object type=image/svg+xml data=https://blog.littlejo.link/assets/svg/xdp/tcp-connections.svg width=100%></object></p><p>On voit seulement les paquets qui sont envoy√©s par le client (ceux en <em>ingress</em>).</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=namepaces src=https://blog.littlejo.link/assets/svg/xdp/namespaces-ddos-client-xdp.svg></figure></p><p>Si on veut voir les paquets qui sont envoy√©s par le serveur, il faut installer le programme sur l&rsquo;interface <code>veth7</code>. C&rsquo;est tout simple, en surchargeant la variable <code>iface</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>cargo</span> run <span class=na>-- --iface</span> veth7
</span></span></code></pre></div><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=namepaces src=https://blog.littlejo.link/assets/svg/xdp/namespaces-ddos-server-xdp.svg></figure></p><p>Pour afficher un peu plus de d√©tails sur la nature des paquets, regardons maintenant l&rsquo;en-t√™te du segment TCP :</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="TCP Hdr" src=https://blog.littlejo.link/assets/svg/xdp/packet-tcphdr.svg></figure></p><p>Pour les puristes, le sch√©ma est <a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol#TCP_segment_structure target=_blank>un peu simplifi√©</a>.</p><p>Voyons bri√®vement √† quoi servent les principales donn√©es :</p><ul><li>SRC/DST PORT : les ports de TCP</li><li>SEQUENCE/ACK NUMBER : pour le suivi des connexions</li><li>BITFIELD : c&rsquo;est l√† o√π on d√©finit la nature du segment (<em>SYN</em>, <em>ACK</em>, etc)</li><li>WINDOW : pour le contr√¥le de flux (utile pour les gros fichiers)</li><li>CHECKSUM : pour l&rsquo;int√©grit√© du segment</li></ul><p>Comme pour UDP, on peut donc facilement r√©cup√©rer les √©l√©ments en regardant la documentation de la crate <a href=https://docs.rs/network-types/latest/network_types/tcp/struct.TcpHdr.html target=_blank>network-types</a> :</p><p><a href=https://docs.rs/network-types/latest/network_types/tcp/struct.TcpHdr.html target=_blank><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Documentation TCPHdr" src=https://blog.littlejo.link/assets/screenshot/xdp/tcphdr.webp></figure></a></p><p>Pour r√©cup√©rer la nature du segment, il y a m√™me des fonctions pour nous aider :</p><p><a href=https://docs.rs/network-types/latest/network_types/tcp/struct.TcpHdr.html#implementations target=_blank><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Documentation TCPHdr" src=https://blog.littlejo.link/assets/screenshot/xdp/tcphdr-method.webp></figure></a></p><p>Pour reproduire un petit <em>tcpdump</em>, ajoutons cela par exemple :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>src_port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u16</span>::<span class=n>from_be_bytes</span><span class=p>(</span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>source</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>dst_port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u16</span>::<span class=n>from_be_bytes</span><span class=p>(</span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>dest</span><span class=w> </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>seq</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u32</span>::<span class=n>from_be_bytes</span><span class=p>(</span><span class=k>unsafe</span><span class=w> </span><span class=p>{(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>seq</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>ack_seq</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>u32</span>::<span class=n>from_be_bytes</span><span class=p>(</span><span class=k>unsafe</span><span class=w> </span><span class=p>{(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>ack_seq</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>syn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>syn</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>ack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>ack</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>psh</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>psh</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>fin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>fin</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;seq: {}, ack_seq: {}, syn: {}, ack: {}, data: {}, fin: {}, src: {:i}:{}, dst: {:i}:{}&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                 </span><span class=n>seq</span><span class=p>,</span><span class=w> </span><span class=n>ack_seq</span><span class=p>,</span><span class=w> </span><span class=n>syn</span><span class=p>,</span><span class=w> </span><span class=n>ack</span><span class=p>,</span><span class=w> </span><span class=n>psh</span><span class=p>,</span><span class=w> </span><span class=n>fin</span><span class=p>,</span><span class=w> </span><span class=n>src_addr</span><span class=p>,</span><span class=w> </span><span class=n>src_port</span><span class=p>,</span><span class=w> </span><span class=n>dst_addr</span><span class=p>,</span><span class=w> </span><span class=n>dst_port</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Installons ce programme sur les deux interfaces r√©seaux :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>ip</span> netns <span class=nb>exec </span>lb cargo run
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>cargo</span> run <span class=na>-- --iface</span> veth7
</span></span></code></pre></div><p>Lan√ßons une connexion :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>curl</span> <span class=m>10</span>.<span class=m>0</span>.<span class=m>0</span>.<span class=m>10</span>:<span class=m>8080</span>
</span></span></code></pre></div><p>Au niveau de <code>veth6</code>, on voit alors les d√©tails des diff√©rents segments :</p><pre tabindex=0><code>[INFO  antiddos_xdp] seq: 2481734691, ack_seq: 0, syn: 1, ack: 0, data: 0, fin: 0, src: 10.0.0.1:47632, dst: 10.0.0.10:8080
[INFO  antiddos_xdp] seq: 2481734692, ack_seq: 161636304, syn: 0, ack: 1, data: 0, fin: 0, src: 10.0.0.1:47632, dst: 10.0.0.10:8080
[INFO  antiddos_xdp] seq: 2481734692, ack_seq: 161636304, syn: 0, ack: 1, data: 1, fin: 0, src: 10.0.0.1:47632, dst: 10.0.0.10:8080
[INFO  antiddos_xdp] seq: 2481734769, ack_seq: 161636460, syn: 0, ack: 1, data: 0, fin: 0, src: 10.0.0.1:47632, dst: 10.0.0.10:8080
[INFO  antiddos_xdp] seq: 2481734769, ack_seq: 161637894, syn: 0, ack: 1, data: 0, fin: 0, src: 10.0.0.1:47632, dst: 10.0.0.10:8080
[INFO  antiddos_xdp] seq: 2481734769, ack_seq: 161637894, syn: 0, ack: 1, data: 0, fin: 1, src: 10.0.0.1:47632, dst: 10.0.0.10:8080
[INFO  antiddos_xdp] seq: 2481734770, ack_seq: 161637895, syn: 0, ack: 1, data: 0, fin: 0, src: 10.0.0.1:47632, dst: 10.0.0.10:8080
</code></pre><p>Au niveau de <code>veth7</code> :</p><pre tabindex=0><code>[INFO  antiddos_xdp] seq: 161636303, ack_seq: 2481734692, syn: 1, ack: 1, data: 0, fin: 0, src: 10.0.0.10:8080, dst: 10.0.0.1:47632,
[INFO  antiddos_xdp] seq: 161636304, ack_seq: 2481734769, syn: 0, ack: 1, data: 0, fin: 0, src: 10.0.0.10:8080, dst: 10.0.0.1:47632,
[INFO  antiddos_xdp] seq: 161636304, ack_seq: 2481734769, syn: 0, ack: 1, data: 1, fin: 0, src: 10.0.0.10:8080, dst: 10.0.0.1:47632,
[INFO  antiddos_xdp] seq: 161636460, ack_seq: 2481734769, syn: 0, ack: 1, data: 1, fin: 0, src: 10.0.0.10:8080, dst: 10.0.0.1:47632,
[INFO  antiddos_xdp] seq: 161637894, ack_seq: 2481734769, syn: 0, ack: 1, data: 0, fin: 1, src: 10.0.0.10:8080, dst: 10.0.0.1:47632,
[INFO  antiddos_xdp] seq: 161637895, ack_seq: 2481734770, syn: 0, ack: 1, data: 0, fin: 0, src: 10.0.0.10:8080, dst: 10.0.0.1:47632,
</code></pre><p>Maintenant qu&rsquo;on a vu tous les d√©tails d&rsquo;un segment TCP, on va maintenant s&rsquo;occuper uniquement des segments de type <em>SYN</em> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>syn</span><span class=p>()</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=mi>1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Si on a affaire √† un <em>SYN</em>, on continue le traitement sinon on laisse passer le paquet.</p><p>Comme nous n&rsquo;allons plus toucher √† cette partie du code, nous allons cr√©er une fonction :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>filter_tcp_syn_src</span><span class=p>(</span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>XdpContext</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4</span><span class=p>]</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ethhdr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>EthHdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ptr_at</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>).</span><span class=n>ok</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>ethhdr</span><span class=p>).</span><span class=n>ether_type</span><span class=p>()</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>EtherType</span>::<span class=n>Ipv4</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ipv4hdr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>Ipv4Hdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ptr_at</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>EthHdr</span>::<span class=no>LEN</span><span class=p>).</span><span class=n>ok</span><span class=p>()</span><span class=o>?</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>ipv4hdr</span><span class=p>).</span><span class=n>proto</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>IpProto</span>::<span class=n>Tcp</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>tcphdr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>TcpHdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ptr_at</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=n>EthHdr</span>::<span class=no>LEN</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Ipv4Hdr</span>::<span class=no>LEN</span><span class=p>).</span><span class=n>ok</span><span class=p>()</span><span class=o>?</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>tcphdr</span><span class=p>).</span><span class=n>syn</span><span class=p>()</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=mi>1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>src_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>ipv4hdr</span><span class=p>).</span><span class=n>src_addr</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Some</span><span class=p>(</span><span class=n>src_addr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>try_antiddos_xdp</span><span class=p>(</span><span class=n>ctx</span>: <span class=nc>XdpContext</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u32</span><span class=p>,</span><span class=w> </span><span class=kt>u32</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>src_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>filter_tcp_syn_src</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>src_addr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Nous r√©cup√©rons uniquement l&rsquo;IP source de cette fonction pour potentiellement la bloquer.</p><p>Cela va nous permettre de nous concentrer sur le code pour emp√™cher l&rsquo;attaque.</p><hr><h2 class="relative group">Essayons d&rsquo;att√©nuer les attaques SYN flood<div id=essayons-datt√©nuer-les-attaques-syn-flood class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#essayons-datt%c3%a9nuer-les-attaques-syn-flood aria-label=Ancre>#</a></span></h2><h3 class="relative group">Token Bucket<div id=token-bucket class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#token-bucket aria-label=Ancre>#</a></span></h3><p>Il y a diff√©rentes options pour att√©nuer les DDoS. Je vais parler de l&rsquo;algorithme du seau √† jetons (<em><a href=https://en.wikipedia.org/wiki/Token_bucket target=_blank>token bucket</a></em>). C&rsquo;est pas mal utilis√© comme algorithme (par exemple nginx avec <code>limit_req</code>).</p><p>Pour comprendre cet algorithme, nous allons faire une petite analogie :</p><blockquote><p>Un village impose des restrictions alimentaires :</p><ul><li>Chaque foyer doit faire la queue pour obtenir des paniers</li><li>Le village ne peut pas stocker plus de 5 paniers √† la fois par foyer</li><li>Si le foyer a r√©cup√©r√© tous ses paniers, il doit attendre le lendemain pour en avoir de nouveaux</li><li>Si le foyer n&rsquo;a pas pris de panier depuis quelques jours, il peut en r√©cup√©rer plusieurs jusqu&rsquo;√† la limite de 5 paniers.</li></ul></blockquote><p>Cette m√©thode va ainsi limiter les abus tout en √©tant flexible en permettant de ne pas faire la queue tous les jours.</p><p>En appliquant cette id√©e √† la protection contre les attaques <em>SYN Flood</em>, on obtient :</p><ul><li>Chaque IP doit faire la queue pour envoyer un paquet <em>SYN</em> √† un serveur</li><li>Le serveur ne peut pas recevoir plus de 5 paquets <em>SYN</em> √† la fois par IP</li><li>Si l&rsquo;IP a d√©j√† envoy√© tous ses paquets <em>SYN</em>, elle sera bloqu√©e temporairement et devra attendre un peu pour pouvoir envoyer de nouveaux</li><li>Si l&rsquo;IP n&rsquo;a pas envoy√© de paquets <em>SYN</em> depuis quelques temps, il peut en envoyer plusieurs jusqu&rsquo;√† la limite de 5.</li></ul><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="TCP Hdr" src=https://blog.littlejo.link/assets/svg/xdp/token-bucket.svg></figure></p><p>Bon c&rsquo;est bien beau mais comment on fait concr√®tement en eBPF ?</p><h3 class="relative group">Comment l&rsquo;impl√©menter dans eBPF ?<div id=comment-limpl√©menter-dans-ebpf- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#comment-limpl%c3%a9menter-dans-ebpf- aria-label=Ancre>#</a></span></h3><p>Nous allons cr√©er une map eBPF: BUCKET <code>{ip => TOKEN}</code>. Si l&rsquo;IP n&rsquo;est pas dans BUCKET, il va √™tre initialis√© au nombre maximal (qui est √† 5 dans l&rsquo;analogie). √Ä chaque fois qu&rsquo;on re√ßoit un <em>SYN</em>, on diminue de 1. Si le bucket est vide, on arr√™te le paquet.</p><div class="flex px-4 py-3 rounded-md
alert-info"><span class="pe-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg fill="currentColor" width="96" height="92.25" viewBox="0 0 24 23.0625" id="svg1"><path d="m24 0-1.40625.625-6.625 2.84375-7.625-2.875-.375-.125-.375.15625-7 3L0 3.875v19.1875l1.40625-.625 6.625-2.84375 7.625 2.875.375.125.375-.15625 7-3L24 19.1875zM9 2.96875l6 2.25v14.875l-6-2.25zm-2 .0625V17.875L2 20.03125V5.1875zm15 0V17.875l-5 2.15625V5.1875z" id="path1"/></svg>
</span></span><span class=dark:text-neutral-300><p>Pour ceux qui ne savent pas ce qu&rsquo;est une map eBPF : en simplifiant, on peut la voir comme une variable globale persistante √† un programme eBPF. √Ä chaque fois que le programme XDP est lanc√©, il peut acc√©der et modifier cette variable.</p><p>Pour en savoir plus, je te conseille de lire la troisi√®me partie de ma s√©rie <a href=https://medium.com/@littel.jo/sinitier-%C3%A0-ebpf-avec-aya-partie-3-df8cea58b19e target=_blank>S‚Äôinitier √† eBPF avec Aya</a>.</p></span></div><p>L&rsquo;algorithme n&rsquo;est pas complet car toutes les IPs finiraient par √™tre bloqu√©e, il faut rajouter des jetons. La solution intuitive serait de cr√©er un programme utilisateur qui remplit la map eBPF de 1 r√©guli√®rement. Mais c&rsquo;est un peu risqu√© si par exemple le programme plante.</p><p>Une astuce serait de cr√©er une autre map eBPF : LAST_TS : <code>{ip => ts}</code>. Il contient le moment o√π on a remplit le BUCKET pour la derni√®re fois. Ainsi dans le programme eBPF, on peut calculer la dur√©e qui s&rsquo;est √©coul√©e et rattraper √©ventuellement le retard en rajoutant les jetons. Supposons qu&rsquo;on est cens√© donner un jeton par seconde, si le dernier remplissage date d&rsquo;il y a 5 secondes, on rajoute 5 jetons dans la limite de la taille du seau.</p><div class="flex px-4 py-3 rounded-md
alert-tip"><span class="pe-3 flex items-center
alert-icon-tip"><span class="relative block icon"><svg width="35.895355" height="36.001198" viewBox="0 0 35.895355 36.001198" fill="none" id="svg13"><path fill-rule="evenodd" clip-rule="evenodd" d="m23.6364.10692772c.484.244422.6756.829517.4279 1.30684198-.489.9425-.7536 2.29434-.8548 3.68384-.0998 1.37144-.0333 2.66933.0689 3.4332.0712.53167-.308 1.01948-.847 1.08955s-1.0337-.30413-1.1048-.83581c-.1203-.89834-.1899-2.32813-.0808-3.82659.1078-1.4804.3972-3.14069 1.0658-4.42931998.2477-.4773282.8408-.666135 1.3248-.421712z" fill="#1a1a1a" id="path1"/><path d="m17.9279 15.4786c.591-2.7701-5.4162-3.2222-8.49374-3.1019-12.13253.2574-7.06117 7.5956-.344 8.4137 2.76434.3367 8.09894-1.8492 8.83774-5.3118z" fill="currentColor" id="path2"/><path d="m3.00152 13.9149c.34054-.2771.78266-.5279 1.33721-.743l.17291.5359.88014 1.0998 1.28927 1.153.9905-.145 4.95105-.5064 5.2045.5492c-.1637.515-.4287.9991-.7694 1.4477C15.5173 17.0017 11.9211 16.9114 9.96784 16.9078 9.44518 17.5136 9.25598 19.5736 9.2151 20.8038 9.17288 20.7999 9.1312 20.7954 9.09009 20.7904 8.54185 20.7236 8.00457 20.6134 7.48672 20.4672 7.43882 19.5053 7.77515 18.1299 8.01989 17.3664 6.48879 17.4486 4.86925 18.1947 3.97602 18.7145 3.56434 18.3884 3.20739 18.0402 2.91797 17.6812l1.98456-1.0757C4.59621 16.4519 3.62819 14.9452 3.00152 13.9149z" fill="currentColor" id="path3"/><path d="M16.8986 18.8203l1.7838 1.1899-8.0602 11.7636-1.9367-1.2919-1.48753-2.1642-.74485-3.5732 1.33387-3.1389 3.20141.9634z" fill="currentColor" id="path4"/><path fill-rule="evenodd" clip-rule="evenodd" d="M15.2758 11.0042c2.3911-5.0861403 8.2076-3.8391103 10.9546-2.0068003L18.6815 20.0147 17.8151 19.4368c-1.1 1.2586-3.3469 2.2113-4.3328 2.5303.1001 1.4145 1.3034 2.5052 1.8925 2.8737l-2.4801 3.6196c-2.89488-1.931-3.74047-4.6925-3.80141-5.8318l-1.0745-.0575c-1.89715 4.2428 1.07775 7.5309 2.91251 8.7548L7.72792 36.0012 8.28497 31.6116c-3.61109-3.0533-2.96504-7.6667-2.19063-9.5917C3.60654 21.5324-.71116398 17.9714.09996132 14.9451 1.51225 9.6757097 10.7796 9.7630597 15.2758 11.0042zm2.6538 4.4605c.5621-2.7545-5.4263-3.2044-8.49737-3.0844-1.95229.0414-3.45912.2662-4.5853.6176.50118 1.5357 1.66332 2.2994 2.22769 2.4976 3.56078-.7988 8.18428-.4303 10.85498-.0308zM17.705 16.192c-1.8625-.2387-4.6377-.3002-6.0775-.2966-1.95525 1.3169-2.20603 3.5377-2.03968 4.9319 2.64838.0449 6.94048-1.776 8.11718-4.6353zm-9.01016 4.5464c-.35729-2.0196.79278-3.9252 1.49856-4.7008-3.62095.1363-5.90362 1.15-7.01878 1.9457 1.19325 1.2879 3.24214 2.3888 5.52022 2.7551zM2.5405 17.15c.89512-.5396 2.4988-1.0361 3.3714-1.2581-1.26155-.9307-1.8124-1.9023-2.00718-2.5311-1.97331.9358-2.197 2.4008-1.36422 3.7892z" fill="#1a1a1a" id="path5"/><path fill-rule="evenodd" clip-rule="evenodd" d="m35.5569 8.0548297c-.4102-.35197-1.0318-.30931-1.3885.09529-.7042.79888-1.8771 1.54484-3.1462 2.1552803-1.2527.6024-2.4981 1.0253-3.2547 1.2163-.5265.1329-.844.6619-.7091 1.1814.1349.5195.6711.8329 1.1977.6999.8897-.2246 2.2604-.6937 3.6291-1.352 1.3521-.6503 2.8058-1.534 3.7687-2.6262703.3566-.4046.3132-1.01792-.097-1.3699z" fill="#1a1a1a" id="path6"/><path d="m23.2275 19.0151c2.385-1.5734 5.0488 3.7584 6.0825 6.621 4.2791 11.2045-4.5124 9.2957-7.785 3.4503-1.3468-2.4055-1.2788-8.1045 1.7025-10.0713z" fill="currentColor" id="path7"/><path d="m30.2594 32.1c.1337-.4151.2048-.9133.2005-1.5012L29.8914 30.6402 28.529 30.2441 26.9642 29.4933 26.7315 28.5324l-1.3687-4.7219L22.9067 19.25c-.4233.3418-.7798.7648-1.0748 1.2439.8604 1.297 2.2853 4.556 3.0167 6.343-.3751.7043-2.242 1.6452-3.3838 2.1411.0194.0372.0392.0737.0592.1095.2671.477.571.9279.9015 1.3475.9225-.3145 2.0908-1.135 2.7176-1.6436.4933 1.4325.3951 3.1933.2391 4.2049.4601.2554.9206.4525 1.3661.5837l.2722-2.2179c.2586.2232 2.0364.548 3.2389.7379z" fill="currentColor" id="path8"/><path d="m20.4651 21.1977-1.7838-1.1899-8.0602 11.7636 1.9367 1.2919 2.5898.5554 3.6382-.6495 2.4552-2.391-2.0992-2.5722z" fill="currentColor" id="path9"/><path fill-rule="evenodd" clip-rule="evenodd" d="M28.4238 19.774C32.3164 15.6893 28.976 10.8284 26.229 8.9960897L18.6802 20.0134l.8664.578c-.7738 1.4761-.8325 3.8884-.7651 4.9099-1.3678.4355-2.8419-.2597-3.4081-.6618l-2.48 3.6196c2.8948 1.931 5.8072 1.6761 6.9015 1.3073l.4544.9624c-3.2834 3.3181-7.4845 1.8196-9.3193.5958l-3.20344 4.6753 3.92084-2.1458c4.2173 2.1685 8.3155-.1422 9.8375-1.5687 1.3855 2.0962 6.3437 4.7225 8.8878 2.8521 4.4296-3.2567.8939-11.7094-1.9489-15.3635zm-5.1841-.7677c2.3812-1.5411 5.036 3.7742 6.0675 6.6308.6886 1.8029 1.0387 3.2663 1.1278 4.4284-1.6311.1134-2.7824-.666-3.1791-1.1089-.5757-3.5579-2.6452-7.6538-4.0162-9.9503zm-.6003.4767c.9185 1.6163 2.0106 4.1343 2.5437 5.4541-.51 2.2809-2.5052 3.3381-3.8784 3.7053-1.0291-2.4081-.916-7.0166 1.3347-9.1594zm-.9184 9.9439c2.0327-.4255 3.3963-2.1886 3.8628-3.1238 1.2211 3.3661 1.1184 5.8339.7856 7.1514-1.656-.6126-3.4549-2.0783-4.6484-4.0276zm5.6684 4.2977c.174-1.0207.0433-2.674-.073-3.5557 1.3454.8082 2.4645.9505 3.1284.8946-.1447 2.1554-1.4393 2.9062-3.0554 2.6611z" fill="#1a1a1a" id="path10"/></svg>
</span></span><span class=dark:text-neutral-300>Pour des questions de performance, on devrait probablement cr√©er une unique map <code>{ip => {num => token, last_fill => ts }</code>. Mais je trouve cela plus simple en s√©parant en deux maps.</span></div><hr><h2 class="relative group">Repassons au code<div id=repassons-au-code class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#repassons-au-code aria-label=Ancre>#</a></span></h2><h3 class="relative group">D√©cr√©mentation de la map Bucket<div id=d√©cr√©mentation-de-la-map-bucket class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#d%c3%a9cr%c3%a9mentation-de-la-map-bucket aria-label=Ancre>#</a></span></h3><p>On va d√©j√† cr√©er la map qui contient les jetons, on utilise une map de type <a href=https://docs.ebpf.io/linux/map-type/BPF_MAP_TYPE_LRU_HASH/ target=_blank>BPF_MAP_TYPE_LRU_HASH</a> :</p><p><a href=https://docs.rs/aya-ebpf/latest/aya_ebpf/maps/hash_map/struct.LruHashMap.html target=_blank><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="LRU Hash Map" src=https://blog.littlejo.link/assets/screenshot/xdp/lru_hash_map.webp></figure></a></p><p>Elle permet de nettoyer automatiquement les entr√©es en cas de d√©bordement, on limite le nombre d&rsquo;IPs √† 16 :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>aya_ebpf</span>::<span class=n>macros</span>::<span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>aya_ebpf</span>::<span class=n>maps</span>::<span class=n>LruHashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[map]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>static</span><span class=w> </span><span class=no>BUCKET</span>: <span class=nc>LruHashMap</span><span class=o>&lt;</span><span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4</span><span class=p>],</span><span class=w> </span><span class=kt>u64</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LruHashMap</span>::<span class=n>with_max_entries</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Pour trouver le nombre de jetons du bucket, nous allons regarder si la map contient d√©j√† cet IP :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>BUCKET</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=o>&amp;</span><span class=n>src_addr</span><span class=p>)}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=o>*</span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>None</span><span class=w>    </span><span class=o>=&gt;</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=c1>//Token max
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>Le seau ne peut pas contenir plus de 5 jetons. Nous cr√©erons une constante √† la fin.</p><p>On va soustraire de 1 le nombre de jeton et on va remplir la map :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=n>saturating_sub</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>BUCKET</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=o>&amp;</span><span class=n>source_addr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>token_final</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-info"><span class="pe-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg fill="currentColor" width="685.64758" height="685.71362" viewBox="0 0 11.999 12.000156" role="img" focusable="false" aria-hidden="true" id="svg1"><path d="M11.915172 5.853138 11.411397 5.541524c-.004-.04905-.0087-.0981-.01443-.146573l.432797-.403944c.04386-.04097.06348-.101562.05194-.160423-.01154-.05886-.05309-.10791-.109064-.128685L11.219237 4.494734c-.01385-.0479-.02828-.09521-.04328-.143111L11.52104 3.872085C11.55624 3.823615 11.56317 3.760135 11.54066 3.70416 11.51815 3.64818 11.46737 3.60894 11.408513 3.599134l-.58341-.09521c-.0225-.04443-.04616-.08771-.0704-.130993l.245251-.538398c.02481-.05482.0202-.118298-.01385-.168503-.03405-.0502-.08944-.07906-.150036-.07675L10.244003 2.61005C10.213423 2.57196 10.182253 2.53388 10.150523 2.496369l.136187-.577061c.01385-.05886-.0035-.120029-.04617-.162732-.0427-.0427-.103872-.06001-.162155-.04616L9.5019002 1.846603c-.03751-.03174-.07559-.0629-.113681-.09348l.02078-.592066c.0023-.06001-.02712-.117143-.07675-.150036-.04963-.03289-.113681-.03866-.167925-.01385l-.538398.245251c-.04328-.02366-.08714-.04732-.130993-.0704l-.09522-.58341c-.0098-.05944-.04905-.109642-.105025-.132147-.05598-.02251-.118875-.01558-.167348.01962l-.47954.345074c-.04732-.015-.09464-.02943-.142534-.04328L7.2981012.224477c-.02078-.05655-.06983-.0981-.128685-.109642-.05886-.01154-.119452.0081-.160423.05194L6.6050495.600148C6.5565765.594948 6.5075255.589758 6.4584758.585718L6.1468624.081943C6.115124.031161 6.059149.0 5.9991346.0 5.9391206.0 5.8831452.03116 5.8519838.08194L5.5403705.585715c-.04905.004-.0981.0092-.1471508.01443L4.9892765.166771C4.9483055.122911 4.8877136.103291 4.8288533.114831 4.7699933.126371 4.7209427.167921 4.7001685.224473L4.4930033.777875c-.047896.01385-.095215.02828-.1425342.04328L3.8709307.476076c-.04905-.0352-.112527-.0427-.167925-.01962s-.095215.07329-.1044482.132147l-.095215.58341c-.043857.02251-.087713.04616-.130993.0704L2.8339507.997163c-.054821-.02481-.1182977-.01962-.1685021.01385-.050204.03347-.079057.09002-.076749.150036l.020774.592066c-.038086.03058-.076172.06174-.1136811.09348l-.5770618-.136184c-.058283-.01385-.1200289.004-.1621544.04616-.042126.04213-.060014.103871-.046165.162732l.1361865.577061c-.031738.03751-.0629.07502-.093484.113681L1.1610484 2.589275c-.060014-.0017-.1165665.02712-.150036.07675-.03347.04963-.038663.113682-.01385.168503l.2452512.538398c-.023659.04328-.047319.08656-.070402.130993L.5886021 3.599129C.5291651 3.608929.4795375 3.648179.456455 3.704155.433372 3.760135.440874 3.823029.476075 3.87208l.3450829.479538c-.015004.04732-.02943.09521-.04328.143111l-.5534007.20717c-.055975.02078-.097523.06982-.1090646.128685-.011541.05886.00808.119452.051935.160423l.4327964.403944C.594954 5.444001.589757 5.492471.585717 5.541524L.081943 5.853138C.031162 5.884876.0 5.940274.0 6.000866.0 6.061456.031161 6.116855.081943 6.148016l.5037751.311614c.00404.04905.00923.0981.014427.146573l-.4327964.403944c-.043857.04097-.063477.101563-.051935.160423.011541.05886.05309.107333.1090646.128685L.7778806 7.50642c.01385.0479.028276.09579.04328.143111L.4760762 8.129069c-.035201.04905-.042703.11195-.01962.167348.023082.0554.073287.09522.1321471.105026l.5834095.09521c.022505.04443.046165.08771.070402.130993L.9971636 9.165467c-.024814.05482-.01962.118298.01385.168503.033469.0502.090599.07906.150036.07675L1.753115 9.38995c.030584.03866.061746.07617.093484.113681l-.1361865.577061c-.01385.05886.00346.119452.046165.162155.042703.0427.1038711.06001.1621544.04616l.5770618-.13561c.037509.03174.075595.0629.1136811.09348l-.020774.592643c-.00231.06001.027122.117143.076749.150036.049627.03289.1136812.03866.1685021.01327l.5383986-.245251c.04328.02424.087136.04732.130993.0704l.095215.58341c.00981.05944.04905.109642.1050253.132147.055975.02251.1188747.01558.167925-.01904l.4795383-.34566c.047319.015.095215.02943.1431113.04328l.2071652.553402c.020774.05598.069824.09752.1286848.109065.05886.01154.1194518-.0081.1604232-.05194l.4039432-.432796c.048473.0058.098101.01039.1471508.01443l.3116134.503775c.031161.05078.087136.08194.1471507.08194.060014.0.1159895-.03116.1471508-.08194l.3116134-.503775c.04905-.004.0981-.0092.1465737-.01443l.4039436.432796c.04097.04386.101562.06348.160423.05194.05886-.01154.107333-.05309.128685-.109065l.207165-.553402c.0479-.01385.09579-.02828.143111-.04328l.479538.34566c.04847.0352.11195.04213.167348.01904.0554-.02308.09522-.07329.105026-.132147l.09521-.58341c.04386-.02308.08771-.04674.130993-.0704l.538398.245251c.05482.02481.118298.0202.167925-.01327.04963-.03347.07906-.09002.07675-.150036l-.02078-.592643c.03809-.03058.07617-.06174.113682-.09348l.5770608.13561c.05828.01385.120029-.0035.162155-.04616.04213-.0427.06001-.103871.04617-.162155l-.13561-.577061c.03174-.03751.0629-.07502.09348-.113681l.592066.02077c.06001.0023.117143-.02655.150036-.07675.03289-.0502.03866-.113682.01327-.168503L10.756422 8.627646c.02366-.04328.04732-.08714.0704-.130993l.58341-.09521c.05944-.0092.109065-.04905.132147-.105026.02308-.05598.01558-.118874-.01962-.167348L11.177676 7.649531c.015-.04732.02943-.09521.04328-.143111l.553402-.207165c.05598-.02135.09752-.06982.109065-.128685.01212-.05886-.0075-.119452-.05194-.160423L11.398687 6.606203c.0052-.04905.0098-.09752.01443-.146573l.503775-.311614c.05078-.03116.08194-.08714.08194-.14715s-.03116-.11599-.08194-.147728zm-3.3717718 4.178504c-.192162-.04155-.314499-.231402-.273527-.42414.04097-.192739.230824-.315653.422986-.273527.192738.04097.315076.230824.273527.423563-.04155.192739-.230825.315076-.422986.274104zM8.3720132 8.874056c-.175427-.03751-.347969.07386-.385478.249868l-.178889.835008c-.552248.250445-1.1645106.389517-1.8102428.389517-.6601587.0-1.2862707-.145996-1.8483289-.407405L3.9701853 9.106612C3.9326763 8.931185 3.7601348 8.819235 3.5847081 8.856744L2.8478002 9.014859C2.7110365 8.874056 2.5840829 8.72402 2.4669394 8.565905h3.5852849c.040394.0.067516-.0075.067516-.04443V7.253093c0-.03693-.027122-.04443-.067516-.04443H5.003703V6.404816h1.1339264c.1032941.0.5534023.02943.6970907.604761.045011.176581.1442651.752488.2117821.936571.06752.206588.34162.619187.63419.619187h1.786584c.0202.0.04213-.0023.06463-.0063-.124069.168502-.259678.327771-.406252.476653L8.3720132 8.873479zM3.4138978 10.01433C3.2217362 10.05588 3.0318829 9.93296 2.9909115 9.740226 2.9499405 9.547487 3.0722775 9.357634 3.2644388 9.316086 3.4566003 9.275116 3.6464537 9.397456 3.6874251 9.59019 3.7283961 9.782929 3.6060591 9.972782 3.4138978 10.01433zM2.0537631 4.499351C2.1333981 4.679394 2.0526131 4.890599 1.8725657 4.970233 1.6925224 5.049863 1.4824719 4.969033 1.4022604 4.788459 1.3226254 4.608415 1.4034104 4.397788 1.5834578 4.317576 1.763501 4.237366 1.9735515 4.318776 2.0537631 4.499351zm-.4177927.990815.7674922-.341044C2.5673481 5.076412 2.641212 4.884251 2.5685022 4.719788L2.4103873 4.36201h.6214956V7.164222H1.7773505c-.1090647-.382592-.1673479-.785958-.1673479-1.203174.0-.159269.00866-.316807.024814-.471459zM5.0042801 5.21837V4.392594h1.4807405c.076749.0.5401296.08829.5401296.435105.0.287954-.3554698.390671-.6480401.390671zm5.3799469.743255c0 .109642-.004.21813-.01212.325463H9.9219982c-.04501.0-.06348.02943-.06348.07386v.206588c0 .486463-.274682.592643-.514739.619188-.229094.02597-.483001-.09579-.514162-.236019-.135033-.759413-.360087-.921567-.715557-1.202019.441452-.279875.900216-.693052.900216-1.246454.0-.597259-.409714-.973503-.688434-1.157586C7.9340172 3.0867 7.5006432 3.034764 7.3840772 3.034764H2.7289194c.6313116-.704588 1.4865172-1.20317 2.4542498-1.384944l.5487858.575907c.1240683.129839.3295023.134456.4593412.01039l.6139937-.587448c1.2862703.23948 2.3757633 1.040442 3.0030293 2.139168L9.3882182 4.7371c-.07271.164463.0017.356624.165617.429334l.8090408.35951c.01385.143688.02135.289108.02135.435681zM5.7325321 1.160471C5.8744893 1.024285 6.1001204 1.029478 6.236307 1.172011 6.3724936 1.314545 6.366723 1.540753 6.224189 1.676363 6.0822318 1.812549 5.8566006 1.807356 5.7204141 1.664823 5.5842275 1.522289 5.5899981 1.296658 5.7325321 1.160471zM9.9035352 4.516663C9.9831652 4.336619 10.193797 4.255254 10.37384 4.334888 10.553883 4.414518 10.634672 4.625727 10.555037 4.805771 10.475407 4.985814 10.264775 5.06718 10.084732 4.987545 9.9046892 4.907915 9.8239002 4.696706 9.9035352 4.516663z" id="path1"/></svg>
</span></span><span class=dark:text-neutral-300><code>saturating_sub</code> est une <a href=https://doc.rust-lang.org/core/primitive.u32.html#method.saturating_sub target=_blank>m√©thode core</a> de Rust. Elle emp√™che que le nombre de jetons soit n√©gatif. Pour un entier naturel √ßa serait bizarre.</span></div><p>Si le nombre de jeton est nulle, on bloque le paquet :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;drop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_DROP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Sinon on affiche le nombre de token :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;received a packet, token {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>token_final</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Pour ne rien oublier, voici le code principal :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>aya_ebpf</span>::<span class=p>{</span><span class=n>macros</span>::<span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>maps</span>::<span class=n>LruHashMap</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[map]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>static</span><span class=w> </span><span class=no>BUCKET</span>: <span class=nc>LruHashMap</span><span class=o>&lt;</span><span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4</span><span class=p>],</span><span class=w> </span><span class=kt>u64</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LruHashMap</span>::<span class=n>with_max_entries</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>try_antiddos_xdp</span><span class=p>(</span><span class=n>ctx</span>: <span class=nc>XdpContext</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u32</span><span class=p>,</span><span class=w> </span><span class=kt>u32</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>src_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>filter_tcp_syn_src</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>BUCKET</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=o>&amp;</span><span class=n>src_addr</span><span class=p>)}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=o>*</span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>None</span><span class=w>    </span><span class=o>=&gt;</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=c1>//Token max
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>token</span><span class=p>.</span><span class=n>saturating_sub</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>BUCKET</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=o>&amp;</span><span class=n>src_addr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>token_final</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;drop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_DROP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;received a packet, token {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>token_final</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-info"><span class="pe-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg fill="currentColor" width="96" height="92.25" viewBox="0 0 24 23.0625" id="svg1"><path d="m24 0-1.40625.625-6.625 2.84375-7.625-2.875-.375-.125-.375.15625-7 3L0 3.875v19.1875l1.40625-.625 6.625-2.84375 7.625 2.875.375.125.375-.15625 7-3L24 19.1875zM9 2.96875l6 2.25v14.875l-6-2.25zm-2 .0625V17.875L2 20.03125V5.1875zm15 0V17.875l-5 2.15625V5.1875z" id="path1"/></svg>
</span></span><span class=dark:text-neutral-300><p>Pour plus de renseignements sur la map, n&rsquo;h√©sitez pas √† lire la <a href=https://docs.rs/aya-ebpf/latest/aya_ebpf/maps/hash_map/struct.LruHashMap.html target=_blank>doc</a> :</p><p><a href=https://docs.rs/aya-ebpf/latest/aya_ebpf/maps/hash_map/struct.LruHashMap.html target=_blank><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="Aya doc" src=https://blog.littlejo.link/assets/screenshot/xdp/lru_hash_map-aya.webp></figure></a></p></span></div><p>V√©rifions :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nf>ip</span> netns <span class=nb>exec </span>lb cargo run
</span></span></code></pre></div><p>Lan√ßons 6 fois :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nf>curl</span> <span class=m>10</span>.<span class=m>0</span>.<span class=m>0</span>.<span class=m>10</span>:<span class=m>8080</span>
</span></span></code></pre></div><p>Sur le terminal de <code>cargo run</code>, on a le r√©sultat escompt√© :</p><pre tabindex=0><code>[INFO  antiddos_xdp] received a packet, token 4
[INFO  antiddos_xdp] received a packet, token 3
[INFO  antiddos_xdp] received a packet, token 2
[INFO  antiddos_xdp] received a packet, token 1
[INFO  antiddos_xdp] drop
[INFO  antiddos_xdp] drop
[INFO  antiddos_xdp] drop
</code></pre><p>√Ä la fin, comme <em>curl</em> n&rsquo;arrive pas √† se connecter au serveur, il doit retransmettre des <em>SYN</em>.</p><h3 class="relative group">Calcul du rajout des jetons<div id=calcul-du-rajout-des-jetons class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#calcul-du-rajout-des-jetons aria-label=Ancre>#</a></span></h3><p>Le programme actuel ne peut que vider le seau et donc bloquer au final tous les flux. Passons maintenant au remplissage du seau. Pour cela, nous avons besoin d&rsquo;une autre map <code>LAST_TS</code> qui va contenir, pour chaque IP, le <em>timestamp</em> du dernier remplissage :</p><p>Cr√©ons la map :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=cp>#[map]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>static</span><span class=w> </span><span class=no>LAST_TS</span>: <span class=nc>LruHashMap</span><span class=o>&lt;</span><span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4</span><span class=p>],</span><span class=w> </span><span class=kt>u64</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LruHashMap</span>::<span class=n>with_max_entries</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>De mani√®re similaire que pour la map <code>BUCKET</code>, nous allons r√©cup√©rer le <em>timestamp</em> de la map <code>LAST_TS</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>LAST_TS</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=o>&amp;</span><span class=n>source_addr</span><span class=p>)}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=o>*</span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>None</span><span class=w>    </span><span class=o>=&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>Pour forcer la cr√©ation de l&rsquo;entr√©e dans la map, j&rsquo;ai mis un <em>timestamp</em> de z√©ro si l&rsquo;entr√©e n&rsquo;existe pas.</p><p>Calculons le nombre de jeton qu&rsquo;il faut rajouter :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=n>bpf_ktime_get_ns</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>ts</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>token_add</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>1_000_000_000</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-info"><span class="pe-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none"><path d="M21 13.25c0 4.968-4.032 9-9 9s-9-4.032-9-9 4.032-9 9-9 9 4.032 9 9z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8.25v5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 1.75h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
</span></span><span class=dark:text-neutral-300><p>La fonction <code>bpf_ktime_get_ns()</code> permet de calculer le temps depuis le d√©marrage du syst√®me :</p><p><a href=https://docs.ebpf.io/linux/helper-function/bpf_ktime_get_ns/ target=_blank><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt="ebpf doc" src=https://blog.littlejo.link/assets/screenshot/xdp/bpf_ktime_get_ns.webp></figure></a></p><p>Les timestamps sont exprim√©s en nano seconde. On rajoute ici 1 jeton par seconde √©coul√©e.</p></span></div><p>S&rsquo;il faut en rajouter, on met √† jour la map :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=n>token_add</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>LAST_TS</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=o>&amp;</span><span class=n>source_addr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>On calcule le nombre total de jeton dans le seau :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>min</span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=n>saturating_sub</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>token_add</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Avec la fonction min, on √©vite que le bucket peut contenir plus que 5 jetons.</p><p>Pour debugger :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;token {}, duration {}, token_add {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>token_final</span><span class=p>,</span><span class=w> </span><span class=n>duration</span><span class=p>,</span><span class=w> </span><span class=n>token_add</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>En am√©liorant le code avec des fonctions, cela donne :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>aya_ebpf_bindings</span>::<span class=n>helpers</span>::<span class=n>bpf_ktime_get_ns</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>core</span>::<span class=n>cmp</span>::<span class=n>min</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>TOKEN_BUCKET_SIZE</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>5</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>REFILL_INTERVAL_NS</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>1_000_000_000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>refill_tokens</span><span class=p>(</span><span class=n>src_addr</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4</span><span class=p>])</span><span class=w> </span>-&gt; <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>LAST_TS</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=n>src_addr</span><span class=p>)}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=o>*</span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>None</span><span class=w>    </span><span class=o>=&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=n>bpf_ktime_get_ns</span><span class=p>()};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>ts</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token_add</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=no>REFILL_INTERVAL_NS</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>token_add</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>LAST_TS</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>src_addr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>token_add</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[inline(always)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>consume_token</span><span class=p>(</span><span class=n>ctx</span>: <span class=kp>&amp;</span><span class=nc>XdpContext</span><span class=p>,</span><span class=w> </span><span class=n>src_addr</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>;</span><span class=w> </span><span class=mi>4</span><span class=p>])</span><span class=w> </span>-&gt; <span class=kt>u64</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=no>BUCKET</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=n>src_addr</span><span class=p>)}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=o>*</span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>None</span><span class=w>    </span><span class=o>=&gt;</span><span class=w> </span><span class=no>TOKEN_BUCKET_SIZE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token_add</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>refill_tokens</span><span class=p>(</span><span class=n>src_addr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>min</span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=n>saturating_sub</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>token_add</span><span class=p>,</span><span class=w> </span><span class=no>TOKEN_BUCKET_SIZE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=no>BUCKET</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>src_addr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>token_final</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;token {}, token_add {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>token_final</span><span class=p>,</span><span class=w> </span><span class=n>token_add</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>token_final</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>try_antiddos_xdp</span><span class=p>(</span><span class=n>ctx</span>: <span class=nc>XdpContext</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u32</span><span class=p>,</span><span class=w> </span><span class=kt>u32</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>src_addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>filter_tcp_syn_src</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>Some</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>consume_token</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>src_addr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>token_final</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;drop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_DROP</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>xdp_action</span>::<span class=no>XDP_PASS</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Testons le code maintenant :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>ip</span> netns <span class=nb>exec </span>lb cargo run
</span></span></code></pre></div><p>En lan√ßant successivement cette commande curl :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>curl</span> <span class=m>10</span>.<span class=m>0</span>.<span class=m>0</span>.<span class=m>10</span>:<span class=m>8080</span>
</span></span></code></pre></div><p>On obtient ce genre d&rsquo;affichage :</p><pre tabindex=0><code>[INFO  antiddos_xdp] token 5, token_add 456446
[INFO  antiddos_xdp] token 5, token_add 5
[INFO  antiddos_xdp] token 5, token_add 5
[INFO  antiddos_xdp] token 4, token_add 0
[INFO  antiddos_xdp] token 4, token_add 1
[INFO  antiddos_xdp] token 3, token_add 0
[INFO  antiddos_xdp] token 3, token_add 1
[INFO  antiddos_xdp] token 2, token_add 0
[INFO  antiddos_xdp] token 2, token_add 1
[INFO  antiddos_xdp] token 1, token_add 0
[INFO  antiddos_xdp] token 1, token_add 1
[INFO  antiddos_xdp] drop
[INFO  antiddos_xdp] token 1, token_add 1
[INFO  antiddos_xdp] token 5, token_add 11
</code></pre><p>La premi√®re fois, on a initialis√© √† 0 donc la dur√©e est le timestamp. On doit ajouter 456446 jetons mais comme le seau ne peut contenir que 5 jetons on a 5 jetons.</p><h3 class="relative group">Limite du programme<div id=limite-du-programme class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#limite-du-programme aria-label=Ancre>#</a></span></h3><p>Si tu testes avec des outils comme <code>hping</code> qui peuvent g√©n√©rer al√©atoirement des IPs, le programme ne pourra pas faire grand chose contre cela. Ces outils g√©n√®rent des paquets qui n&rsquo;ont pas de coh√©rence, il vaut mieux le d√©tecter et arr√™ter le paquet. Ainsi pour des DDoS massifs, un filtrage avec des r√®gles dynamiques, comme <a href=https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/ target=_blank>Cloudflare le fait</a> serait beaucoup plus efficace.</p><hr><p>Cet √©pisode est maintenant termin√© ! Nous avons vu les bases des connexions TCP et des pistes pour att√©nuer des DDoS.</p><p>Jusqu&rsquo;√† maintenant, nous avons soit observ√© soit bloqu√© le paquet mais nous n&rsquo;avons pas encore vu comment modifier le paquet.</p><p>Dans le prochain √©pisode, nous allons voir cela en cr√©ant un petit <strong>load balancer XDP</strong>.</p></div><details class="mt-2 mb-5 overflow-hidden rounded-lg ms-0 ps-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 -ms-5 ps-5 dark:bg-primary-800 dark:text-neutral-100">Apprenons XDP avec Aya -
Cet article fait partie d'une s√©rie.</summary><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/ebpf-another-type/xdp/intro/>Partie 1:
XDP, le firewall ultra rapide de Linux</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/ebpf-another-type/xdp/example-1/>Partie 2:
Impl√©mentons un petit firewall avec XDP</a></div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">Partie 3:
Cet article</div><div class="py-1 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><a href=/ebpf-another-type/xdp/example-3-tr/>Partie 4:
Cr√©ons un petit load balancer avec XDP</a></div></details><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.littlejo.link/ebpf-another-type/xdp/example-2/&amp;title=Att%c3%a9nuons%20les%20attaques%20DDoS%20avec%20XDP" title="Poster sur LinkedIn" aria-label="Poster sur LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://bsky.app/intent/compose?text=Att%c3%a9nuons%20les%20attaques%20DDoS%20avec%20XDP+https://blog.littlejo.link/ebpf-another-type/xdp/example-2/" title aria-label><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span>
</a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://s2f.kytta.dev/?text=Att%c3%a9nuons%20les%20attaques%20DDoS%20avec%20XDP%20https://blog.littlejo.link/ebpf-another-type/xdp/example-2/" title aria-label><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://blog.littlejo.link/ebpf-another-type/xdp/example-2/&amp;subject=Att%c3%a9nuons%20les%20attaques%20DDoS%20avec%20XDP" title="Envoyer par email" aria-label="Envoyer par email"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_ebpf-another-type/xdp/example-2/index.md data-oid-likes=likes_ebpf-another-type/xdp/example-2/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/ebpf-another-type/xdp/example-1/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Impl√©mentons un petit firewall avec XDP
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-10-29T10:49:51+01:00>29 octobre 2025</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/ebpf-another-type/xdp/example-3-tr/><span class=leading-6>Cr√©ons un petit load balancer avec XDP&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-11-24T10:40:39+01:00>24 novembre 2025</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-24 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Faire d√©filer jusqu'au bas de la page" title="Faire d√©filer jusqu'au bas de la page">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/tags/ title=Tags>Tags</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Joseph Ligier</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom):not(a > img)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://blog.littlejo.link/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Rechercher tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Fermer (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>