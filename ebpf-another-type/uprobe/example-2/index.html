<!doctype html><html lang=fr dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="fr"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Sondons une biblioth√®que avec une uProbe &#183; Le blog de Little Jo</title><meta name=title content="Sondons une biblioth√®que avec une uProbe &#183; Le blog de Little Jo"><meta name=description content="Sondons la fonction `execve` dans la libc avec un programme eBPF de type uProve et avec Aya"><meta name=keywords content="Rust,eBPF,aya,uprobe,"><link rel=canonical href=https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/><link type=text/css rel=stylesheet href=/css/main.bundle.min.2bef69aa0d5bbd53f1fcc50836e6b87ebca45feb416b22a989d6f651ca847c2782a5a481fe2d49f05ee298ad615a9cb55b9682c0902a34b1f1bcd58d473c4385.css integrity="sha512-K+9pqg1bvVPx/MUINua4frykX+tBayKpidb2UcqEfCeCpaSB/i1J8F7imK1hWpy1W5aCwJAqNLHxvNWNRzxDhQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.98bb8ce8f123e03c4d2171eeec151dd404b5c476beb5ef1068d0e8b1a2afb923065e6552fc14b2d867c85ee4bd8529a43193f729f874d3908517ba03b5d1cc57.js integrity="sha512-mLuM6PEj4DxNIXHu7BUd1AS1xHa+te8QaNDosaKvuSMGXmVS/BSy2GfIXuS9hSmkMZP3Kfh005CFF7oDtdHMVw==" data-copy=Copier data-copied=Copi√©></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/"><meta property="og:site_name" content="Le blog de Little Jo"><meta property="og:title" content="Sondons une biblioth√®que avec une uProbe"><meta property="og:description" content="Sondons la fonction `execve` dans la libc avec un programme eBPF de type uProve et avec Aya"><meta property="og:locale" content="fr"><meta property="og:type" content="article"><meta property="article:section" content="ebpf-another-type"><meta property="article:published_time" content="2025-09-23T09:14:16+02:00"><meta property="article:modified_time" content="2025-09-23T09:14:16+02:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="EBPF"><meta property="article:tag" content="Aya"><meta property="article:tag" content="Uprobe"><meta property="og:image" content="https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/featured.webp"><meta property="og:see_also" content="https://blog.littlejo.link/ebpf-another-type/uprobe/example-3-tr/"><meta property="og:see_also" content="https://blog.littlejo.link/ebpf-another-type/uprobe/example-1/"><meta property="og:see_also" content="https://blog.littlejo.link/ebpf-another-type/uprobe/intro/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/featured.webp"><meta name=twitter:title content="Sondons une biblioth√®que avec une uProbe"><meta name=twitter:description content="Sondons la fonction `execve` dans la libc avec un programme eBPF de type uProve et avec Aya"><meta name=twitter:image content="https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/featured.webp"><meta property="og:image" content="https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/featured.webp"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Ebpf-Another-Types","name":"Sondons une biblioth√®que avec une uProbe","headline":"Sondons une biblioth√®que avec une uProbe","description":"Sondons la fonction \u0060execve\u0060 dans la libc avec un programme eBPF de type uProve et avec Aya","abstract":"Sondons la fonction \u003ccode\u003eexecve\u003c\/code\u003e dans la libc avec un programme eBPF de type uProve et avec Aya","inLanguage":"fr","url":"https:\/\/blog.littlejo.link\/ebpf-another-type\/uprobe\/example-2\/","author":{"@type":"Person","name":"Joseph Ligier"},"copyrightYear":"2025","dateCreated":"2025-09-23T09:14:16\u002b02:00","datePublished":"2025-09-23T09:14:16\u002b02:00","dateModified":"2025-09-23T09:14:16\u002b02:00","keywords":["Rust","eBPF","aya","uprobe"],"mainEntityOfPage":"true","wordCount":"2023"}]</script><meta name=author content="Joseph Ligier"><link href=https://bsky.app/profile/littlejo.bsky.social rel=me><link href=https://www.linkedin.com/in/joseph-ligier-4b86632 rel=me><link href=https://dev.to/littlejo rel=me><link href=https://medium.com/@littel.jo rel=me><link href=https://github.com/littlejo rel=me><link href=https://ko-fi.com/littlejo rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script data-goatcounter=https://littlejo-prd.goatcounter.com/count async src=/js/count.js></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Aller au contenu</a></div><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Le blog de Little Jo</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/categories/introduction/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Introduction>Blog</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class="ltr:mr-1 rtl:ml-1"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Sondons une biblioth√®que avec une uProbe">FR</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/ebpf-another-type/uprobe/example-2/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Sondons une biblioth√®que avec une uProbe">FR</p></a><a href=/en/ebpf-another-type/uprobe/example-2/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Let‚Äôs Probe a Library with an eBPF uProbe">EN</p></a></div></div></div></div><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Rechercher (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span><div><div class="cursor-pointer flex items-center nested-menu"><span class="ltr:mr-1 rtl:ml-1"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span></span><div class="text-sm font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Sondons une biblioth√®que avec une uProbe">FR</div></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=/ebpf-another-type/uprobe/example-2/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Sondons une biblioth√®que avec une uProbe">FR</p></a><a href=/en/ebpf-another-type/uprobe/example-2/ class="flex items-center"><p class="text-sm font-sm text-gray-500 hover:text-primary-600 dark:hover:text-primary-400" title="Let‚Äôs Probe a Library with an eBPF uProbe">EN</p></a></div></div></div></div><button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Rechercher (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/categories/introduction/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Introduction>Blog</p></a></li></ul></div></div></div></div><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/ebpf-another-type/uprobe/example-2/featured_hu_d1e792c07a8e6c74.webp alt="Background Image" class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/js/background-blur.min.0ad33cb9c066f652728b2cc09c9ceaf32645544f48e8b6b38f120d86f433ed997da275a49e6151fe0176430c45376812708d84727f3f969101fb44a4345b3f34.js integrity="sha512-CtM8ucBm9lJyiyzAnJzq8yZFVE9I6LazjxINhvQz7Zl9onWknmFR/gF2QwxFN2gScI2Ecn8/lpEB+0SkNFs/NA==" data-target-id=background-blur data-image-id=background-image data-image-url=/ebpf-another-type/uprobe/example-2/featured.webp></script><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Le blog de Little Jo</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/ebpf-another-type/>Ebpf-Another-Types</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/ebpf-another-type/uprobe/example-2/>Sondons une biblioth√®que avec une uProbe</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Sondons une biblioth√®que avec une uProbe</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-09-23T09:14:16+02:00>23 septembre 2025</time><span class="px-2 text-primary-500">&#183;</span><span>2023 mots</span><span class="px-2 text-primary-500">&#183;</span><span title="Temps de lecture">10 mins</span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.9814dee9614d32aeb56239d118edfe20acd6231424f9b19c2dd48835038414130a5e946c0d1c9087d60e60e31840c9babfd217e3d4b95643dc8d651a71ccdf4a.js integrity="sha512-mBTe6WFNMq61YjnRGO3+IKzWIxQk+bGcLdSINQOEFBMKXpRsDRyQh9YOYOMYQMm6v9IX49S5VkPcjWUacczfSg=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title="Activer le mode zen" data-title-i18n-disable="Activer le mode zen" data-title-i18n-enable="D√©sactiver le mode zen"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentColor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="Joseph Ligier" src=/img/littlejo_hu_4250d52962eec5b0.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Auteur</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Joseph Ligier</div><div class="text-sm text-neutral-700 dark:text-neutral-400">CNCF ambassador | Kubestronaut üêù</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://bsky.app/profile/littlejo.bsky.social target=_blank aria-label=Bluesky rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/joseph-ligier-4b86632 target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://dev.to/littlejo target=_blank aria-label=Dev rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88.0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59.0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21.0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44.0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44.0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://medium.com/@littel.jo target=_blank aria-label=Medium rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M180.5 74.262C80.813 74.262.0 155.633.0 256S80.819 437.738 180.5 437.738 361 356.373 361 256 280.191 74.262 180.5 74.262zm288.25 10.646c-49.845.0-90.245 76.619-90.245 171.095s40.406 171.1 90.251 171.1 90.251-76.619 90.251-171.1H559C559 161.5 518.6 84.908 468.752 84.908zm139.506 17.821c-17.526.0-31.735 68.628-31.735 153.274s14.2 153.274 31.735 153.274S640 340.631 640 256c0-84.649-14.215-153.271-31.742-153.271z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/littlejo target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://ko-fi.com/littlejo target=_blank aria-label=Ko-Fi rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg width="211.67mm" height="211.67mm" viewBox="0 0 211.67 211.67"><defs><clipPath id="clipPath25"><path d="m0 6e2h1654.8V0H0z" fill="currentColor"/></clipPath></defs><g transform="translate(-3.0786 -29.59)"><g transform="matrix(.35278 0 0 -.35278 3.0785 241.26)"><g clip-path="url(#clipPath25)"><g transform="translate(600 300)"><path d="m-3e2 3e2c-165.69.0-3e2-134.31-3e2-3e2s134.31-3e2 3e2-3e2C-134.32-3e2.0-165.69.0.0s-134.32 3e2-3e2 3e2zm-188.93-166.99h329.58c23.223.0 46.032-6.8325 65.073-20.125 18.412-12.856 36.378-33.646 42.697-67.02 14.674-77.514-43.568-135.76-126.12-131.18.438-21.268-3.8105-59.422-44.878-69.696-3.282-.821-6.6604-1.186-10.044-1.207-72.13-.448-222.53-.88916-222.53-.88916s-46.066-.01555-49.176 45.962c-1.023 77.88-.48339 223.69-.48339 223.69s-.02651 2.9267-.02051 3.6577c.043 5.607 4.4359 16.8 15.901 16.8zm312.71-55.573v-107.8s14.302-1.6507 31.907.54932c20.356 6.6 39.06 20.901 39.06 57.199.0 14.85-5.2614 25.601-11.837 33.239-9.341 10.848-23.152 16.809-37.469 16.809h-21.661z" fill="currentColor"/></g><g transform="translate(256.61 203.37)"><path d="m0 0c3.585-1.806 5.876.437 5.876.437s52.457 47.878 76.089 75.452c21.018 24.667 22.389 66.234-13.708 81.766-36.096 15.532-65.795-18.272-65.795-18.272-25.755 28.326-64.734 26.891-82.763 7.721-18.027-19.169-11.732-52.072 1.717-70.383 12.626-17.19 68.119-66.65 76.529-75.015.0.0.614-.641 2.055-1.706" fill="currentColor"/></g></g></g></g></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Sommaire</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#que-va-t-on-vraiment-faire-->Que va-t-on vraiment faire ?</a><ul><li><a href=#libc>Libc</a></li><li><a href=#la-fonction-execve>La fonction execve</a></li><li><a href=#les-arguments-de-la-fonction-execve>Les arguments de la fonction execve</a></li><li><a href=#comment-d√©clencher-le-programme-ebpf->Comment d√©clencher le programme eBPF ?</a></li></ul></li><li><a href=#g√©n√©rons-un-programme-aya-de-type-uprobe>G√©n√©rons un programme Aya de type uProbe</a><ul><li><a href=#testons-avec-bpftrace>Testons avec bpftrace</a></li><li><a href=#g√©n√©ration-et-compilation-du-programme-aya>G√©n√©ration et compilation du programme Aya</a></li><li><a href=#test-du-programme>Test du programme</a></li></ul></li><li><a href=#r√©cup√©rons-le-nom-du-binaire>R√©cup√©rons le nom du binaire</a><ul><li><a href=#testons-avec-bpftrace-1>Testons avec bpftrace</a></li><li><a href=#modifions-le-code-aya>Modifions le code Aya</a></li><li><a href=#testons-maintenant-la-modification>Testons maintenant la modification</a></li></ul></li><li><a href=#r√©cup√©rons-les-options-de-la-commande>R√©cup√©rons les options de la commande</a><ul><li><a href=#testons-avec-bpftrace-2>Testons avec bpftrace</a></li><li><a href=#modifions-le-code-aya-1>Modifions le code Aya</a></li><li><a href=#testons-maintenant-la-modification-1>Testons maintenant la modification</a></li></ul></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Sommaire</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#que-va-t-on-vraiment-faire-->Que va-t-on vraiment faire ?</a><ul><li><a href=#libc>Libc</a></li><li><a href=#la-fonction-execve>La fonction execve</a></li><li><a href=#les-arguments-de-la-fonction-execve>Les arguments de la fonction execve</a></li><li><a href=#comment-d√©clencher-le-programme-ebpf->Comment d√©clencher le programme eBPF ?</a></li></ul></li><li><a href=#g√©n√©rons-un-programme-aya-de-type-uprobe>G√©n√©rons un programme Aya de type uProbe</a><ul><li><a href=#testons-avec-bpftrace>Testons avec bpftrace</a></li><li><a href=#g√©n√©ration-et-compilation-du-programme-aya>G√©n√©ration et compilation du programme Aya</a></li><li><a href=#test-du-programme>Test du programme</a></li></ul></li><li><a href=#r√©cup√©rons-le-nom-du-binaire>R√©cup√©rons le nom du binaire</a><ul><li><a href=#testons-avec-bpftrace-1>Testons avec bpftrace</a></li><li><a href=#modifions-le-code-aya>Modifions le code Aya</a></li><li><a href=#testons-maintenant-la-modification>Testons maintenant la modification</a></li></ul></li><li><a href=#r√©cup√©rons-les-options-de-la-commande>R√©cup√©rons les options de la commande</a><ul><li><a href=#testons-avec-bpftrace-2>Testons avec bpftrace</a></li><li><a href=#modifions-le-code-aya-1>Modifions le code Aya</a></li><li><a href=#testons-maintenant-la-modification-1>Testons maintenant la modification</a></li></ul></li></ul></nav></div></details><script>(function(){"use strict";const n=.33,s="#TableOfContents",o=".anchor",i='a[href^="#"]',a="li ul",r="active";function c(e,t){const s=window.scrollY+window.innerHeight*t,o=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],n=new Set(o.map(e=>e.getAttribute("href").substring(1)));for(let t=e.length-1;t>=0;t--){const o=e[t].getBoundingClientRect().top+window.scrollY;if(o<=s&&n.has(e[t].id))return e[t].id}return e.find(e=>n.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=c(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(r,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function t(){const t=document.querySelector(s);if(!t)return;const c=!1,l=[...document.querySelectorAll(o)],d=[...t.querySelectorAll(i)];c&&t.querySelectorAll(a).forEach(e=>e.style.display="none");const r={toc:t,anchors:l,links:d,scrollOffset:n,collapseInactive:c};window.addEventListener("scroll",()=>e(r),{passive:!0}),window.addEventListener("hashchange",()=>e(r),{passive:!0}),e(r)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t):t()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><details class="mt-2 mb-5 overflow-hidden rounded-lg ltr:ml-0 ltr:pl-5 rtl:mr-0 rtl:pr-5" open><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Apprenons uProbe avec eBPF et Aya -
Cet article fait partie d'une s√©rie.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=/ebpf-another-type/uprobe/intro/>Partie 1:
L‚Äôobservabilit√© pour tous les d√©veloppeurs avec les uProbes</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=/ebpf-another-type/uprobe/example-1/>Partie 2:
Observons une fonction simple de ton programme avec des uProbes</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Partie 3:
Cet article</div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=/ebpf-another-type/uprobe/example-3-tr/>Partie 4:
Profilons un petit programme avec des uProbes</a></div></details><div class="article-content max-w-prose mb-20"><p>Nous avons vu ce qu&rsquo;√©tait un programme de type uProbe dans <a href=/ebpf-another-type/uprobe/intro/>la premi√®re partie</a> : √ßa peut √™tre un moyen de sonder une biblioth√®que.</p><p>Nous allons v√©rifier cela avec un programme Aya qui va r√©cup√©rer les diff√©rents arguments de la fonction <code>execve()</code> de la Libc.</p><div class="flex px-4 py-3 rounded-md
alert-tip"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-tip"><span class="relative block icon"><!doctype html><svg height="800" width="800" id="_x32_" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><style>.st0{fill:currentColor}</style><g><path class="st0" d="M485.235 281.91l-44.273-25.356-65.345 8.26c-1.168-4.886-2.55-9.608-4.173-14.099l46.634-18.049 27.349-47.596-2.954-23.279c18.874-15.396 31.677-45.767 16.762-78.388-18.024-39.422-54.964-47.27-54.964-47.27l2.07 70.755-56.364-28.259c-5.169 72.541 40.787 95.467 69.029 93.252l1.031 8.098-18.917 32.912-40.512 15.688c-13.516-20.728-36.811-43.303-38.589-58.287 5.144-4.336 8.407-10.82 8.407-18.075.0-13.051-10.578-23.631-23.63-23.631s-23.64 10.58-23.64 23.631c0 6.475 2.611 12.34 6.818 16.607-7.007 10.501-6.414 17.723-33.978 17.723-27.555.0-26.97-7.222-33.977-17.723 4.216-4.267 6.826-10.132 6.826-16.607.0-13.051-10.588-23.631-23.648-23.631-13.052.0-23.622 10.58-23.622 23.631.0 7.256 3.263 13.739 8.406 18.075-1.777 14.984-25.073 37.558-38.588 58.287l-40.521-15.688-18.9-32.912 1.022-8.098c28.242 2.215 74.198-20.711 69.021-93.252l-56.364 28.259 2.078-70.755s-36.948 7.849-54.963 47.27c-14.924 32.62-2.113 62.992 16.752 78.388l-2.954 23.279 27.348 47.596 46.635 18.049c-1.606 4.491-2.998 9.213-4.174 14.099l-65.336-8.26L26.756 281.91.0 327.935l15.353 10.158 28.671-37.773 32.088-18.376 56.596 7.162c-.293 4.259-.404 8.518-.301 12.786l-40.71 13.567L52.216 362.84l-6.414 60.279 18.195 2.868 11.42-52.628 30.672-36.811 29.478-9.832c2.216 9.223 5.634 17.929 10.45 25.64l-27.624 19.174-11.867 51.546 15.903 52.791 17.774-4.808-8.569-49.176 9.247-36.064 20.574-14.28c34.467 33.874 81.737 33.643 94.539 33.643 12.812.0 60.073.231 94.549-33.643l20.574 14.28 9.239 36.064-8.56 49.176 17.774 4.808 15.903-52.791-11.876-51.546-27.632-19.174c4.826-7.711 8.244-16.418 10.458-25.64l29.479 9.832 30.68 36.811 11.412 52.628 18.195-2.868-6.414-60.279-39.482-47.381-40.71-13.567c.112-4.267-.009-8.526-.292-12.786l56.595-7.162 32.081 18.376 28.67 37.773L512 327.935 485.235 281.91z"/></g></svg>
</span></span><span class=dark:text-neutral-300><p>Je suppose que vous √™tes d√©j√† dans un <a href=https://aya-rs.dev/book/start/development/ target=_blank>environnement pour d√©velopper avec Aya</a> et que vous avez install√© <a href=https://github.com/bpftrace/bpftrace/blob/master/INSTALL.md target=_blank>bpftrace</a>.
Si ce n&rsquo;est pas le cas, vous pouvez utiliser le lab Killercoda :</p><p><a href=https://killercoda.com/littlejo/course/aya-prod/aya-uprobe target=_blank><figure><img class="my-0 rounded-md" loading=lazy alt="Killer coda screenshot" src=https://blog.littlejo.link/assets/screenshot/uprobe/uprobe-killercoda.webp></figure></a></p></span></div><hr><h2 class="relative group">Que va-t-on vraiment faire ?<div id=que-va-t-on-vraiment-faire-- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#que-va-t-on-vraiment-faire-- aria-label=Ancre>#</a></span></h2><h3 class="relative group">Libc<div id=libc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#libc aria-label=Ancre>#</a></span></h3><p>Contrairement √† la pr√©c√©dente partie o√π on a attach√© notre programme eBPF √† un programme, l√† nous l&rsquo;attachons √† une biblioth√®que partag√©e.</p><p>La libc est la biblioth√®que standard du C. Donc √† chaque fois qu&rsquo;un programme en C (ou en C++) est ex√©cut√©, potentiellement, un programme eBPF pourra √™tre lanc√©.</p><div class="flex px-4 py-3 rounded-md
alert-info"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-info"><span class="relative block icon"><!doctype html><svg fill="currentColor" id="Capa_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="800" height="800" viewBox="0 0 29.791 29.791"><g><g><path d="M23.456 9.531c.722-1.352 2.168-5.081-1.539-8.386 2.429 5.516-3.716 7.132-3.716 7.132l5.35 5.906s4.848.334 6.24-2.341C28.913 11.104 26.094 10.229 23.456 9.531z"/><path d="M7.876 1.146c-3.707 3.305-2.261 7.032-1.54 8.386C3.696 10.229.878 11.104.0 11.844c1.394 2.675 6.24 2.341 6.24 2.341l5.35-5.906C11.59 8.277 5.447 6.662 7.876 1.146z"/><path d="M8.024 13.625c-1.783 3.379 2.885 7.521 3.569 8.247.685.727-2.279 1.086-2.26 2.479.012.836.616 1.684 1.931 2.234-.014-.103-.04-.198-.04-.304.0-.206.069-.399.125-.596-.294-.195-.477-.458-.43-.726.075-.426.683-.676 1.352-.556.672.117 1.157.56 1.081.985-.022.128-.103.232-.206.324-.029.082-.08.164-.08.246.0.66.84 1.22 1.832 1.22.992.0 1.833-.56 1.833-1.22.0-.082-.051-.166-.08-.248-.104-.09-.182-.194-.205-.322-.075-.426.41-.868 1.076-.985.674-.12 1.281.13 1.356.556.047.268-.138.529-.433.728.057.194.125.39.125.594.0.109-.025.216-.043.321 1.322-.539 1.93-1.382 1.93-2.253.0-1.448-3.033-1.699-2.253-2.479.78-.779 5.346-4.865 3.563-8.246l-3.566-5.349h-6.61L8.024 13.625zm1.792 1.966c-.474-.33-.482-1.46-.482-1.46s.679.083 1.271.52c.594.435.802 1.604.978 2.179C11.104 16.044 10.29 15.921 9.816 15.591zM19.188 14.65c.592-.437 1.271-.52 1.271-.52s-.009 1.13-.481 1.46c-.475.33-1.289.453-1.767 1.236C18.385 16.253 18.594 15.085 19.188 14.65z"/><path d="M16.957 25.263c.137.214.219.449.219.701.0.92-1.019 1.664-2.277 1.664-1.258.0-2.277-.744-2.277-1.664.0-.252.082-.487.22-.701-.233-.104-.42-.225-.56-.355-.381.389-.61.862-.61 1.377.0 1.305 1.443 2.361 3.228 2.361 1.786.0 3.229-1.057 3.229-2.361.0-.515-.23-.988-.611-1.377C17.375 25.038 17.189 25.161 16.957 25.263z"/></g></g></svg>
</span></span><span class=dark:text-neutral-300>Je parle de <code>libc</code> tout au long du chapitre. Pour √™tre plus pr√©cis, il faudrait parler de la <strong>glibc</strong> (GNU C Library) l&rsquo;impl√©mentation la plus r√©pandue dans les distributions GNU/Linux (Comme Debian ou Red Hat). Mais il y a d&rsquo;autres impl√©mentations comme <strong>musl</strong> (notamment pour Alpine Linux) ou <strong>ulibc</strong> qui sont plus l√©g√®res et adapt√©es pour les syst√®mes embarqu√©s.</span></div><h3 class="relative group">La fonction execve<div id=la-fonction-execve class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#la-fonction-execve aria-label=Ancre>#</a></span></h3><p><code>execve</code> est un appel syst√®me (un <em>syscall</em>) du noyau Linux. Mais c&rsquo;est aussi le nom d&rsquo;une fonction de la <code>libc</code> qui fait appel √† ce m√™me <em>syscall</em> (un <em>wrapper</em>). Ainsi, √† chaque fois que la fonction <code>execve()</code> de la <code>libc</code> sera appel√©e, notre programme eBPF de type uProbe sera lanc√©.</p><h3 class="relative group">Les arguments de la fonction execve<div id=les-arguments-de-la-fonction-execve class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#les-arguments-de-la-fonction-execve aria-label=Ancre>#</a></span></h3><p>Nous devons √©galement r√©cup√©rer les diff√©rents arguments de la fonction <code>execve()</code>.</p><p>Pour trouver ses arguments, on peut √©videmment regarder dans le code source de la libc. Mais il y a plus simple :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>man</span> execve
</span></span></code></pre></div><p><a href=https://man7.org/linux/man-pages/man2/execve.2.html target=_blank><figure><img class="my-0 rounded-md" loading=lazy alt="man execve" src=https://blog.littlejo.link/assets/screenshot/uprobe/man-execve.webp></figure></a></p><p>La partie qui nous int√©resse est la suivante :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>execve</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>_Nullable</span> <span class=n>argv</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>                  <span class=kt>char</span> <span class=o>*</span><span class=k>const</span> <span class=n>_Nullable</span> <span class=n>envp</span><span class=p>[]);</span>
</span></span></code></pre></div><p>On voit que la fonction a trois arguments :</p><ul><li><code>pathname</code>: le nom de la commande avec le chemin complet (exemple <code>/bin/bash</code>). Il est de type <code>const char *</code> (√©quivalent en Rust √† <code>*const u8</code>).</li><li><code>argv</code>: un tableau d&rsquo;arguments de la commande. Il est de type <code>char *const _Nullable[]</code> (√©quivalent en Rust √† <code>*const *const u8</code>)<ul><li><code>argv[0]</code> : le nom de la commande</li><li><code>argv[1]</code> : la premi√®re option</li><li>etc.</li></ul></li><li><code>envp</code> : un tableau de variables d&rsquo;environnement de la commande. Il est de type <code>char *const _Nullable[]</code> (√©quivalent en Rust √† <code>*const *const u8</code>).</li></ul><div class="flex px-4 py-3 rounded-md
alert-info"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg width="128" height="128" viewBox="0 0 24 24" id="svg2"><path d="M22.354 2.354l-.707-.707-3.436 3.435C16.743 2.595 14.505 1 12 1 7.589 1 4 5.935 4 12a14.024 14.024.0 001.3 5.993l-3.654 3.653.707.707 3.436-3.435C7.257 21.405 9.495 23 12 23c4.411.0 8-4.935 8-11a14.024 14.024.0 00-1.3-5.993zM5 12C5 6.486 8.14 2 12 2c2.222.0 4.202 1.492 5.486 3.807L6.05 17.242A13.23 13.23.0 015 12zm14 0c0 5.514-3.14 10-7 10-2.222.0-4.202-1.492-5.486-3.807L17.95 6.758A13.23 13.23.0 0119 12z" id="path1" style="fill:currentColor"/><path fill="none" d="M0 0h24v24H0z" id="path2"/></svg>
</span></span><span class=dark:text-neutral-300><code>_Nullable</code> indique simplement que la valeur peut √™tre <code>NULL</code>.</span></div><h3 class="relative group">Comment d√©clencher le programme eBPF ?<div id=comment-d√©clencher-le-programme-ebpf- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#comment-d%c3%a9clencher-le-programme-ebpf- aria-label=Ancre>#</a></span></h3><p>Prenons un exemple simple. Si tu lances une commande dans un terminal par exemple <code>ls</code>, que va-t-il se passer ?</p><ul><li>Gr√¢ce √† la variable d&rsquo;environnement <code>PATH</code>, le shell (par exemple le bash) va trouver le bon chemin pour trouver o√π se trouve le binaire <code>ls</code> :</li></ul><pre tabindex=0><code>/usr/bin/ls
</code></pre><ul><li>Pour ex√©cuter le binaire, le shell va alors appeler la fonction <code>execve()</code> de la libc :</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=nf>execve</span><span class=p>(</span><span class=s>&#34;/usr/bin/ls&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s>&#34;ls&#34;</span><span class=p>],</span> <span class=p>[</span><span class=s>&#34;PATH=/bin:/usr/bin&#34;</span><span class=p>,</span> <span class=p>...])</span>
</span></span></code></pre></div><ul><li>Le programme eBPF sera enfin d√©clench√©.</li></ul><p>Voici un petit r√©sum√© de tout cela :</p><p><figure><img class="my-0 rounded-md" loading=lazy alt="Summary of ls launching" src=https://blog.littlejo.link/assets/svg/uprobe/libc.svg></figure></p><p>Il y a √©videmment d&rsquo;autres programmes que des shells qui appellent la fonction <code>execve()</code> de la libc comme <code>systemd</code> pour le d√©marrage des diff√©rents programmes d&rsquo;un syst√®me Linux.</p><p>Ainsi nous allons cr√©er un programme tr√®s proche de celui qu&rsquo;on avait cr√©√© avec le Tracepoint <code>sys_enter_execve</code> lors <a href=https://medium.com/@littel.jo/sinitier-%C3%A0-ebpf-avec-aya-c9d570560261 target=_blank>des articles d&rsquo;initiation √† eBPF</a> mais celui-ci sera attach√© au niveau utilisateur √† la fonction <code>execve()</code> de la libc.</p><hr><h2 class="relative group">G√©n√©rons un programme Aya de type uProbe<div id=g√©n√©rons-un-programme-aya-de-type-uprobe class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#g%c3%a9n%c3%a9rons-un-programme-aya-de-type-uprobe aria-label=Ancre>#</a></span></h2><p>Nous avons donc d√©j√† les r√©ponses aux deux questions :</p><pre tabindex=0><code>ü§∑   Target to attach the (u|uret)probe? (e.g libc):
ü§∑   Function name to attach the (u|uret)probe? (e.g getaddrinfo):
</code></pre><p>Voyons comment cr√©er un programme eBPF <em>hello world</em> pour ce point d&rsquo;attache.</p><h3 class="relative group">Testons avec bpftrace<div id=testons-avec-bpftrace class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#testons-avec-bpftrace aria-label=Ancre>#</a></span></h3><p>V√©rifions d&rsquo;abord que √ßa fonctionne avec la ligne de commande <code>bpftrace</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>sudo</span> <span class=nf>bpftrace</span> <span class=na>-e</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s1>&#39;uprobe:libc:execve { printf(&#34;Hello execve\n&#34;); }&#39;</span>
</span></span></code></pre></div><ul><li><code>uprobe</code> : le type de programme eBPF</li><li><code>libc</code> : le nom de la biblioth√®que</li><li><code>execve</code> : la fonction √† debugger</li><li><code>{ printf("Hello execve\n"); }</code> : le code bpftrace</li></ul><p>√Ä chaque fois qu&rsquo;on lance une commande sur un autre terminal, on voit bien <code>Hello execve</code>.</p><p>Maintenant faisons-le avec Aya.</p><h3 class="relative group">G√©n√©ration et compilation du programme Aya<div id=g√©n√©ration-et-compilation-du-programme-aya class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#g%c3%a9n%c3%a9ration-et-compilation-du-programme-aya aria-label=Ancre>#</a></span></h3><p>La commande <code>cargo generate</code> suivante permet ainsi de g√©nerer le programme eBPF :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl>cargo generate --name test-uprobe-2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -d <span class=nv>program_type</span><span class=o>=</span>uprobe <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -d <span class=nv>uprobe_target</span><span class=o>=</span>libc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               -d <span class=nv>uprobe_fn_name</span><span class=o>=</span>execve <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>               https://github.com/aya-rs/aya-template
</span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-tip"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-tip"><span class="relative block icon"><!doctype html><svg height="800" width="800" id="_x32_" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><style>.st0{fill:currentColor}</style><g><path class="st0" d="M485.235 281.91l-44.273-25.356-65.345 8.26c-1.168-4.886-2.55-9.608-4.173-14.099l46.634-18.049 27.349-47.596-2.954-23.279c18.874-15.396 31.677-45.767 16.762-78.388-18.024-39.422-54.964-47.27-54.964-47.27l2.07 70.755-56.364-28.259c-5.169 72.541 40.787 95.467 69.029 93.252l1.031 8.098-18.917 32.912-40.512 15.688c-13.516-20.728-36.811-43.303-38.589-58.287 5.144-4.336 8.407-10.82 8.407-18.075.0-13.051-10.578-23.631-23.63-23.631s-23.64 10.58-23.64 23.631c0 6.475 2.611 12.34 6.818 16.607-7.007 10.501-6.414 17.723-33.978 17.723-27.555.0-26.97-7.222-33.977-17.723 4.216-4.267 6.826-10.132 6.826-16.607.0-13.051-10.588-23.631-23.648-23.631-13.052.0-23.622 10.58-23.622 23.631.0 7.256 3.263 13.739 8.406 18.075-1.777 14.984-25.073 37.558-38.588 58.287l-40.521-15.688-18.9-32.912 1.022-8.098c28.242 2.215 74.198-20.711 69.021-93.252l-56.364 28.259 2.078-70.755s-36.948 7.849-54.963 47.27c-14.924 32.62-2.113 62.992 16.752 78.388l-2.954 23.279 27.348 47.596 46.635 18.049c-1.606 4.491-2.998 9.213-4.174 14.099l-65.336-8.26L26.756 281.91.0 327.935l15.353 10.158 28.671-37.773 32.088-18.376 56.596 7.162c-.293 4.259-.404 8.518-.301 12.786l-40.71 13.567L52.216 362.84l-6.414 60.279 18.195 2.868 11.42-52.628 30.672-36.811 29.478-9.832c2.216 9.223 5.634 17.929 10.45 25.64l-27.624 19.174-11.867 51.546 15.903 52.791 17.774-4.808-8.569-49.176 9.247-36.064 20.574-14.28c34.467 33.874 81.737 33.643 94.539 33.643 12.812.0 60.073.231 94.549-33.643l20.574 14.28 9.239 36.064-8.56 49.176 17.774 4.808 15.903-52.791-11.876-51.546-27.632-19.174c4.826-7.711 8.244-16.418 10.458-25.64l29.479 9.832 30.68 36.811 11.412 52.628 18.195-2.868-6.414-60.279-39.482-47.381-40.71-13.567c.112-4.267-.009-8.526-.292-12.786l56.595-7.162 32.081 18.376 28.67 37.773L512 327.935 485.235 281.91z"/></g></svg>
</span></span><span class=dark:text-neutral-300>Pour trouver le nom des arguments (<code>uprobe_target</code> et <code>uprobe_fn_name</code>), vous pouvez regarder le fichier <a href=https://github.com/aya-rs/aya-template/blob/e50b81fd6747f5e4247c4d4a7cd8b0c21c51d8bb/test.sh#L46 target=_blank>test.sh</a> dans le repo <a href=https://github.com/aya-rs/aya-template/ target=_blank>aya-template</a>.</span></div><p>Maintenant compilons le et installons le dans le noyau Linux :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=k>cd</span> <span class=k>test</span>-uprobe-<span class=m>2</span>/
</span></span><span class=line><span class=cl><span class=nv>RUST_LOG</span><span class=o>=</span>info <span class=nf>cargo</span> run
</span></span></code></pre></div><h3 class="relative group">Test du programme<div id=test-du-programme class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#test-du-programme aria-label=Ancre>#</a></span></h3><p>Sur un autre terminal, lancer un programme quelconque :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>ls</span>
</span></span></code></pre></div><p>Sur le terminal <code>cargo run</code> vous verrez :</p><pre tabindex=0><code>[INFO  test_uprobe] function execve called by libc
</code></pre><p>Dans la partie pr√©c√©dente, on √©tait rest√© √† ce point concernant les uProbes. Regardons comment r√©cup√©rer les diff√©rentes arguments de la fonction <code>execve()</code>. Commen√ßons par le premier : le nom du binaire.</p><hr><h2 class="relative group">R√©cup√©rons le nom du binaire<div id=r√©cup√©rons-le-nom-du-binaire class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#r%c3%a9cup%c3%a9rons-le-nom-du-binaire aria-label=Ancre>#</a></span></h2><h3 class="relative group">Testons avec bpftrace<div id=testons-avec-bpftrace-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#testons-avec-bpftrace-1 aria-label=Ancre>#</a></span></h3><p>Avant de modifier le code Aya, regardons comment on fait avec <code>bpftrace</code>. C&rsquo;est un poil plus compliqu√© qu&rsquo;un simple <em>hello world</em>.</p><p>Pour r√©cup√©rer le premier argument, on utilise <code>arg0</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>sudo</span> <span class=nf>bpftrace</span> <span class=na>-e</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s1>&#39;uprobe:libc:execve { printf(&#34;%d\n&#34;, arg0); }&#39;</span>
</span></span></code></pre></div><p>On r√©cup√®re l&rsquo;adresse o√π se trouve le premi√®re argument. Comment le &ldquo;convertir&rdquo; en cha√Æne de caract√®res ? Il suffit d&rsquo;utiliser la fonction <code>str()</code> :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>sudo</span> <span class=nf>bpftrace</span> <span class=na>-e</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s1>&#39;uprobe:libc:execve { printf(&#34;%s\n&#34;, str(arg0)); }&#39;</span>
</span></span></code></pre></div><p>Maintenant qu&rsquo;on a le brouillon avec <code>bpftrace</code>, regardons comment l&rsquo;impl√©menter avec Aya.</p><h3 class="relative group">Modifions le code Aya<div id=modifions-le-code-aya class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#modifions-le-code-aya aria-label=Ancre>#</a></span></h3><p>Nous devons modifier la fonction suivante du fichier <code>test-uprobe-2-ebpf/src/main.rs</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>try_test_uprobe_2</span><span class=p>(</span><span class=n>ctx</span>: <span class=nc>ProbeContext</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u32</span><span class=p>,</span><span class=w> </span><span class=kt>u32</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;function execve called by libc&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Il faut donc chercher √† manipuler la variable <code>ctx</code>. Voici <a href=https://docs.rs/aya-ebpf/latest/aya_ebpf/programs/probe/struct.ProbeContext.html target=_blank>la documentation</a> :</p><p><figure><img class="my-0 rounded-md" loading=lazy alt="Documentation of ProbeContext" src=https://blog.littlejo.link/assets/screenshot/uprobe/probecontext.webp></figure></p><p>Il n&rsquo;y a qu&rsquo;une m√©thode qui nous int√©resse :</p><p><a href=https://docs.rs/aya-ebpf/latest/aya_ebpf/programs/probe/struct.ProbeContext.html#method.arg target=_blank><figure><img class="my-0 rounded-md" loading=lazy alt="Documentation of ProbeContext: arg" src=https://blog.littlejo.link/assets/screenshot/uprobe/probecontext-arg.webp></figure></a></p><p>Le premier √©l√©ment est le nom du binaire qui est ex√©cut√©.</p><p>Il faut donc rajouter un truc comme √ßa :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>arg0</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u8</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=n>arg</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=n>ok_or</span><span class=p>(</span><span class=mi>1</span><span class=k>u32</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-info"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-info"><span class="relative block icon"><!doctype html><svg height="800" width="800" id="_x32_" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><style>.st0{fill:currentColor}</style><g><path class="st0" d="M485.235 281.91l-44.273-25.356-65.345 8.26c-1.168-4.886-2.55-9.608-4.173-14.099l46.634-18.049 27.349-47.596-2.954-23.279c18.874-15.396 31.677-45.767 16.762-78.388-18.024-39.422-54.964-47.27-54.964-47.27l2.07 70.755-56.364-28.259c-5.169 72.541 40.787 95.467 69.029 93.252l1.031 8.098-18.917 32.912-40.512 15.688c-13.516-20.728-36.811-43.303-38.589-58.287 5.144-4.336 8.407-10.82 8.407-18.075.0-13.051-10.578-23.631-23.63-23.631s-23.64 10.58-23.64 23.631c0 6.475 2.611 12.34 6.818 16.607-7.007 10.501-6.414 17.723-33.978 17.723-27.555.0-26.97-7.222-33.977-17.723 4.216-4.267 6.826-10.132 6.826-16.607.0-13.051-10.588-23.631-23.648-23.631-13.052.0-23.622 10.58-23.622 23.631.0 7.256 3.263 13.739 8.406 18.075-1.777 14.984-25.073 37.558-38.588 58.287l-40.521-15.688-18.9-32.912 1.022-8.098c28.242 2.215 74.198-20.711 69.021-93.252l-56.364 28.259 2.078-70.755s-36.948 7.849-54.963 47.27c-14.924 32.62-2.113 62.992 16.752 78.388l-2.954 23.279 27.348 47.596 46.635 18.049c-1.606 4.491-2.998 9.213-4.174 14.099l-65.336-8.26L26.756 281.91.0 327.935l15.353 10.158 28.671-37.773 32.088-18.376 56.596 7.162c-.293 4.259-.404 8.518-.301 12.786l-40.71 13.567L52.216 362.84l-6.414 60.279 18.195 2.868 11.42-52.628 30.672-36.811 29.478-9.832c2.216 9.223 5.634 17.929 10.45 25.64l-27.624 19.174-11.867 51.546 15.903 52.791 17.774-4.808-8.569-49.176 9.247-36.064 20.574-14.28c34.467 33.874 81.737 33.643 94.539 33.643 12.812.0 60.073.231 94.549-33.643l20.574 14.28 9.239 36.064-8.56 49.176 17.774 4.808 15.903-52.791-11.876-51.546-27.632-19.174c4.826-7.711 8.244-16.418 10.458-25.64l29.479 9.832 30.68 36.811 11.412 52.628 18.195-2.868-6.414-60.279-39.482-47.381-40.71-13.567c.112-4.267-.009-8.526-.292-12.786l56.595-7.162 32.081 18.376 28.67 37.773L512 327.935 485.235 281.91z"/></g></svg>
</span></span><span class=dark:text-neutral-300>On utilise le type <code>*const u8</code> car le premier argument est de type <code>const char *</code> en C (cf <code>man execve</code>)</span></div><p>Pour &ldquo;convertir&rdquo; ce pointeur en cha√Æne de caract√®re on va le faire de fa√ßon similaire qu&rsquo;on avait fait avec les <em>Tracepoints</em> dans <a href=https://medium.com/@littel.jo/sinitier-%C3%A0-ebpf-avec-aya-partie-2-fdaac12da841 target=_blank>l&rsquo;article d&rsquo;initiation √† la cr√©ation de programme eBPF avec Aya</a>.</p><p>Ainsi on se retrouve avec le code suivant :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>try_test_uprobe_2</span><span class=p>(</span><span class=n>ctx</span>: <span class=nc>ProbeContext</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u32</span><span class=p>,</span><span class=w> </span><span class=kt>i64</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>arg0</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u8</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=n>arg</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=n>ok_or</span><span class=p>(</span><span class=mi>1</span><span class=k>u32</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=k>u8</span><span class=p>;</span><span class=w> </span><span class=mi>128</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>filename</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>filename_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bpf_probe_read_user_str_bytes</span><span class=p>(</span><span class=n>arg0</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>from_utf8_unchecked</span><span class=p>(</span><span class=n>filename_bytes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;function execve called by libc {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>filename</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>√Ä l&rsquo;√©poque ce n&rsquo;√©tait pas tr√®s clair dans mon esprit.</p><p>Expliquons en d√©tail ce code :</p><ul><li>la fonction <em>helper</em> <code>bpf_probe_read_user_str_bytes()</code> permet de lire l&rsquo;adresse m√©moire depuis l&rsquo;espace utilisateur et de r√©cup√©rer son contenu avec un slice d&rsquo;octets. On a besoin d&rsquo;un <em>buffer</em> pour cela.</li><li><code>from_utf8_unchecked()</code> permet de convertir un slice d&rsquo;octets en un <code>&amp;str</code> (la version sans v√©rification car sinon le <em>verifier</em> eBPF n&rsquo;accepte pas)</li></ul><p><a href=https://docs.rs/aya-ebpf/latest/aya_ebpf/helpers/fn.bpf_probe_read_user_str_bytes.html target=_blank><figure><img class="my-0 rounded-md" loading=lazy alt="bpf_probe_read_user_str_bytes documentation" src=https://blog.littlejo.link/assets/screenshot/uprobe/bpf_probe_read_user_str_bytes.webp></figure></a></p><p>Pour finir, voici un petit sch√©ma qui explique comment r√©cup√©rer une chaine de caract√®res depuis l&rsquo;espace utilisateur :</p><p><figure><img class="my-0 rounded-md" loading=lazy alt="Retrieve string from user space" src=https://blog.littlejo.link/assets/svg/uprobe/str-memory.svg></figure></p><div class="flex px-4 py-3 rounded-md
alert-info"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg width="35.895355" height="36.001198" viewBox="0 0 35.895355 36.001198" fill="none" id="svg13"><path fill-rule="evenodd" clip-rule="evenodd" d="m23.6364.10692772c.484.244422.6756.829517.4279 1.30684198-.489.9425-.7536 2.29434-.8548 3.68384-.0998 1.37144-.0333 2.66933.0689 3.4332.0712.53167-.308 1.01948-.847 1.08955s-1.0337-.30413-1.1048-.83581c-.1203-.89834-.1899-2.32813-.0808-3.82659.1078-1.4804.3972-3.14069 1.0658-4.42931998.2477-.4773282.8408-.666135 1.3248-.421712z" fill="#1a1a1a" id="path1"/><path d="m17.9279 15.4786c.591-2.7701-5.4162-3.2222-8.49374-3.1019-12.13253.2574-7.06117 7.5956-.344 8.4137 2.76434.3367 8.09894-1.8492 8.83774-5.3118z" fill="currentColor" id="path2"/><path d="m3.00152 13.9149c.34054-.2771.78266-.5279 1.33721-.743l.17291.5359.88014 1.0998 1.28927 1.153.9905-.145 4.95105-.5064 5.2045.5492c-.1637.515-.4287.9991-.7694 1.4477C15.5173 17.0017 11.9211 16.9114 9.96784 16.9078 9.44518 17.5136 9.25598 19.5736 9.2151 20.8038 9.17288 20.7999 9.1312 20.7954 9.09009 20.7904 8.54185 20.7236 8.00457 20.6134 7.48672 20.4672 7.43882 19.5053 7.77515 18.1299 8.01989 17.3664 6.48879 17.4486 4.86925 18.1947 3.97602 18.7145 3.56434 18.3884 3.20739 18.0402 2.91797 17.6812l1.98456-1.0757C4.59621 16.4519 3.62819 14.9452 3.00152 13.9149z" fill="currentColor" id="path3"/><path d="M16.8986 18.8203l1.7838 1.1899-8.0602 11.7636-1.9367-1.2919-1.48753-2.1642-.74485-3.5732 1.33387-3.1389 3.20141.9634z" fill="currentColor" id="path4"/><path fill-rule="evenodd" clip-rule="evenodd" d="M15.2758 11.0042c2.3911-5.0861403 8.2076-3.8391103 10.9546-2.0068003L18.6815 20.0147 17.8151 19.4368c-1.1 1.2586-3.3469 2.2113-4.3328 2.5303.1001 1.4145 1.3034 2.5052 1.8925 2.8737l-2.4801 3.6196c-2.89488-1.931-3.74047-4.6925-3.80141-5.8318l-1.0745-.0575c-1.89715 4.2428 1.07775 7.5309 2.91251 8.7548L7.72792 36.0012 8.28497 31.6116c-3.61109-3.0533-2.96504-7.6667-2.19063-9.5917C3.60654 21.5324-.71116398 17.9714.09996132 14.9451 1.51225 9.6757097 10.7796 9.7630597 15.2758 11.0042zm2.6538 4.4605c.5621-2.7545-5.4263-3.2044-8.49737-3.0844-1.95229.0414-3.45912.2662-4.5853.6176.50118 1.5357 1.66332 2.2994 2.22769 2.4976 3.56078-.7988 8.18428-.4303 10.85498-.0308zM17.705 16.192c-1.8625-.2387-4.6377-.3002-6.0775-.2966-1.95525 1.3169-2.20603 3.5377-2.03968 4.9319 2.64838.0449 6.94048-1.776 8.11718-4.6353zm-9.01016 4.5464c-.35729-2.0196.79278-3.9252 1.49856-4.7008-3.62095.1363-5.90362 1.15-7.01878 1.9457 1.19325 1.2879 3.24214 2.3888 5.52022 2.7551zM2.5405 17.15c.89512-.5396 2.4988-1.0361 3.3714-1.2581-1.26155-.9307-1.8124-1.9023-2.00718-2.5311-1.97331.9358-2.197 2.4008-1.36422 3.7892z" fill="#1a1a1a" id="path5"/><path fill-rule="evenodd" clip-rule="evenodd" d="m35.5569 8.0548297c-.4102-.35197-1.0318-.30931-1.3885.09529-.7042.79888-1.8771 1.54484-3.1462 2.1552803-1.2527.6024-2.4981 1.0253-3.2547 1.2163-.5265.1329-.844.6619-.7091 1.1814.1349.5195.6711.8329 1.1977.6999.8897-.2246 2.2604-.6937 3.6291-1.352 1.3521-.6503 2.8058-1.534 3.7687-2.6262703.3566-.4046.3132-1.01792-.097-1.3699z" fill="#1a1a1a" id="path6"/><path d="m23.2275 19.0151c2.385-1.5734 5.0488 3.7584 6.0825 6.621 4.2791 11.2045-4.5124 9.2957-7.785 3.4503-1.3468-2.4055-1.2788-8.1045 1.7025-10.0713z" fill="currentColor" id="path7"/><path d="m30.2594 32.1c.1337-.4151.2048-.9133.2005-1.5012L29.8914 30.6402 28.529 30.2441 26.9642 29.4933 26.7315 28.5324l-1.3687-4.7219L22.9067 19.25c-.4233.3418-.7798.7648-1.0748 1.2439.8604 1.297 2.2853 4.556 3.0167 6.343-.3751.7043-2.242 1.6452-3.3838 2.1411.0194.0372.0392.0737.0592.1095.2671.477.571.9279.9015 1.3475.9225-.3145 2.0908-1.135 2.7176-1.6436.4933 1.4325.3951 3.1933.2391 4.2049.4601.2554.9206.4525 1.3661.5837l.2722-2.2179c.2586.2232 2.0364.548 3.2389.7379z" fill="currentColor" id="path8"/><path d="m20.4651 21.1977-1.7838-1.1899-8.0602 11.7636 1.9367 1.2919 2.5898.5554 3.6382-.6495 2.4552-2.391-2.0992-2.5722z" fill="currentColor" id="path9"/><path fill-rule="evenodd" clip-rule="evenodd" d="M28.4238 19.774C32.3164 15.6893 28.976 10.8284 26.229 8.9960897L18.6802 20.0134l.8664.578c-.7738 1.4761-.8325 3.8884-.7651 4.9099-1.3678.4355-2.8419-.2597-3.4081-.6618l-2.48 3.6196c2.8948 1.931 5.8072 1.6761 6.9015 1.3073l.4544.9624c-3.2834 3.3181-7.4845 1.8196-9.3193.5958l-3.20344 4.6753 3.92084-2.1458c4.2173 2.1685 8.3155-.1422 9.8375-1.5687 1.3855 2.0962 6.3437 4.7225 8.8878 2.8521 4.4296-3.2567.8939-11.7094-1.9489-15.3635zm-5.1841-.7677c2.3812-1.5411 5.036 3.7742 6.0675 6.6308.6886 1.8029 1.0387 3.2663 1.1278 4.4284-1.6311.1134-2.7824-.666-3.1791-1.1089-.5757-3.5579-2.6452-7.6538-4.0162-9.9503zm-.6003.4767c.9185 1.6163 2.0106 4.1343 2.5437 5.4541-.51 2.2809-2.5052 3.3381-3.8784 3.7053-1.0291-2.4081-.916-7.0166 1.3347-9.1594zm-.9184 9.9439c2.0327-.4255 3.3963-2.1886 3.8628-3.1238 1.2211 3.3661 1.1184 5.8339.7856 7.1514-1.656-.6126-3.4549-2.0783-4.6484-4.0276zm5.6684 4.2977c.174-1.0207.0433-2.674-.073-3.5557 1.3454.8082 2.4645.9505 3.1284.8946-.1447 2.1554-1.4393 2.9062-3.0554 2.6611z" fill="#1a1a1a" id="path10"/></svg>
</span></span><span class=dark:text-neutral-300>Notez le nom de la fonction <code>bpf_probe_read_user_str_bytes</code> qui prend tout son sens pour une uProbe.</span></div><h3 class="relative group">Testons maintenant la modification<div id=testons-maintenant-la-modification class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#testons-maintenant-la-modification aria-label=Ancre>#</a></span></h3><p>V√©rifions que le code fonctionne toujours :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nv>RUST_LOG</span><span class=o>=</span>info <span class=nf>cargo</span> run
</span></span></code></pre></div><p>Sur un autre terminal, lan√ßons une commande quelconque :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nf>ls</span>
</span></span></code></pre></div><p>Sur le terminal <code>cargo run</code> vous verrez :</p><pre tabindex=0><code>[INFO  test_uprobe_2] function execve called by libc /usr/bin/ls
</code></pre><p>Nous √©tions rest√© √† ce niveau l√† pour <a href=https://medium.com/@littel.jo/sinitier-%C3%A0-ebpf-avec-aya-c9d570560261 target=_blank>les articles d&rsquo;initiation √† eBPF avec Aya</a>. Mais nous aurions √©galement pu aller plus loin en r√©cup√©rant les options de la commande et ses variables d&rsquo;environnement. Voyons comment le faire.</p><hr><h2 class="relative group">R√©cup√©rons les options de la commande<div id=r√©cup√©rons-les-options-de-la-commande class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#r%c3%a9cup%c3%a9rons-les-options-de-la-commande aria-label=Ancre>#</a></span></h2><h3 class="relative group">Testons avec bpftrace<div id=testons-avec-bpftrace-2 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#testons-avec-bpftrace-2 aria-label=Ancre>#</a></span></h3><p>Avant de le faire avec Aya, nous allons regarder comment le faire avec bpftrace. Pour r√©cup√©rer le deuxi√®me argument, on doit utiliser <code>arg1</code>.
Comme <code>arg1</code> est un pointeur de pointeur. On ne peut pas utiliser directement la fonction <code>str()</code>. Il faut d√©r√©f√©rencer arg1 pour avoir un seul pointeur.
Pour cela, il suffit d&rsquo;utiliser <code>*</code>.</p><p>Ce qui nous fait :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>bpftrace</span> <span class=na>-e</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s1>&#39;uprobe:libc:execve { printf(&#34;%s\n&#34;, str(*arg1)); }&#39;</span>
</span></span></code></pre></div><p>On r√©cup√®re alors le premier √©l√©ment du tableau qui est le nom de la commande. Il faut donc se d√©placer dans le tableau si on veut r√©cup√©rer les diff√©rentes options. Chaque √©l√©ment a une taille de 8 octets (uniquement valable en 64 bits).</p><p><figure><img class="my-0 rounded-md" loading=lazy alt="memory access and human value" src=https://blog.littlejo.link/assets/svg/uprobe/cmd-memory.svg></figure></p><p>Pour aller au deuxi√®me √©l√©ment du tableau, c&rsquo;est √† dire √† la premi√®re option, il suffit de se d√©placer de 8 octets (en ajoutant 8) :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Fish data-lang=Fish><span class=line><span class=cl><span class=nf>bpftrace</span> <span class=na>-e</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s1>&#39;uprobe:libc:execve { printf(&#34;%s\n&#34;, str(*(arg1+8))); }&#39;</span>
</span></span></code></pre></div><p>Vous allez voir que la difficult√© va √™tre sensiblement la m√™me en Rust.</p><h3 class="relative group">Modifions le code Aya<div id=modifions-le-code-aya-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#modifions-le-code-aya-1 aria-label=Ancre>#</a></span></h3><p>Avec Aya, pour r√©cup√©rer le deuxi√®me argument, il faut rajouter ce bout de code :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>argv</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=n>arg</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=n>ok_or</span><span class=p>(</span><span class=mi>1</span><span class=k>u32</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Comment r√©cup√©rer la ni√®me option de la commande ? Il faut utiliser la fonction <a href=https://doc.rust-lang.org/core/primitive.pointer.html#method.add target=_blank>add</a> pour pouvoir d√©caler son pointeur vers la bonne adresse m√©moire :</p><p><figure><img class="my-0 rounded-md" loading=lazy alt="Method add documentation" src=https://blog.littlejo.link/assets/screenshot/uprobe/add.webp></figure></p><p>Par exemple, pour r√©cup√©rer la premi√®re option, on va d√©caler de 1 :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>argv1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-info"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-info"><span class="relative block icon"><!doctype html><svg height="800" width="800" id="_x32_" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><style>.st0{fill:currentColor}</style><g><path class="st0" d="M485.235 281.91l-44.273-25.356-65.345 8.26c-1.168-4.886-2.55-9.608-4.173-14.099l46.634-18.049 27.349-47.596-2.954-23.279c18.874-15.396 31.677-45.767 16.762-78.388-18.024-39.422-54.964-47.27-54.964-47.27l2.07 70.755-56.364-28.259c-5.169 72.541 40.787 95.467 69.029 93.252l1.031 8.098-18.917 32.912-40.512 15.688c-13.516-20.728-36.811-43.303-38.589-58.287 5.144-4.336 8.407-10.82 8.407-18.075.0-13.051-10.578-23.631-23.63-23.631s-23.64 10.58-23.64 23.631c0 6.475 2.611 12.34 6.818 16.607-7.007 10.501-6.414 17.723-33.978 17.723-27.555.0-26.97-7.222-33.977-17.723 4.216-4.267 6.826-10.132 6.826-16.607.0-13.051-10.588-23.631-23.648-23.631-13.052.0-23.622 10.58-23.622 23.631.0 7.256 3.263 13.739 8.406 18.075-1.777 14.984-25.073 37.558-38.588 58.287l-40.521-15.688-18.9-32.912 1.022-8.098c28.242 2.215 74.198-20.711 69.021-93.252l-56.364 28.259 2.078-70.755s-36.948 7.849-54.963 47.27c-14.924 32.62-2.113 62.992 16.752 78.388l-2.954 23.279 27.348 47.596 46.635 18.049c-1.606 4.491-2.998 9.213-4.174 14.099l-65.336-8.26L26.756 281.91.0 327.935l15.353 10.158 28.671-37.773 32.088-18.376 56.596 7.162c-.293 4.259-.404 8.518-.301 12.786l-40.71 13.567L52.216 362.84l-6.414 60.279 18.195 2.868 11.42-52.628 30.672-36.811 29.478-9.832c2.216 9.223 5.634 17.929 10.45 25.64l-27.624 19.174-11.867 51.546 15.903 52.791 17.774-4.808-8.569-49.176 9.247-36.064 20.574-14.28c34.467 33.874 81.737 33.643 94.539 33.643 12.812.0 60.073.231 94.549-33.643l20.574 14.28 9.239 36.064-8.56 49.176 17.774 4.808 15.903-52.791-11.876-51.546-27.632-19.174c4.826-7.711 8.244-16.418 10.458-25.64l29.479 9.832 30.68 36.811 11.412 52.628 18.195-2.868-6.414-60.279-39.482-47.381-40.71-13.567c.112-4.267-.009-8.526-.292-12.786l56.595-7.162 32.081 18.376 28.67 37.773L512 327.935 485.235 281.91z"/></g></svg>
</span></span><span class=dark:text-neutral-300>Contrairement √† bpftrace o√π il faut d√©caler du nombre d&rsquo;octets (8 en 64 bits car 8x8=64 bits). La fonction <code>add()</code> permet de se d√©placer d&rsquo;addresse m√©moire de 1 par 1 sans tenir compte de l&rsquo;architecture.</span></div><p>Par contre <code>argv1</code> est encore de structure <code>*const *const u8</code>. Il faut maintenant d√©r√©f√©rencer pour obtenir <code>*const u8</code>.</p><p>Il y a une fonction toute pr√™te pour cela :</p><p><a href=https://docs.rs/aya-ebpf/latest/aya_ebpf/helpers/fn.bpf_probe_read_user.html target=_blank><figure><img class="my-0 rounded-md" loading=lazy alt="bpf_probe_read_user documentation" src=https://blog.littlejo.link/assets/screenshot/uprobe/bpf_probe_read_user.webp></figure></a></p><div class="flex px-4 py-3 rounded-md
alert-info"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg width="35.895355" height="36.001198" viewBox="0 0 35.895355 36.001198" fill="none" id="svg13"><path fill-rule="evenodd" clip-rule="evenodd" d="m23.6364.10692772c.484.244422.6756.829517.4279 1.30684198-.489.9425-.7536 2.29434-.8548 3.68384-.0998 1.37144-.0333 2.66933.0689 3.4332.0712.53167-.308 1.01948-.847 1.08955s-1.0337-.30413-1.1048-.83581c-.1203-.89834-.1899-2.32813-.0808-3.82659.1078-1.4804.3972-3.14069 1.0658-4.42931998.2477-.4773282.8408-.666135 1.3248-.421712z" fill="#1a1a1a" id="path1"/><path d="m17.9279 15.4786c.591-2.7701-5.4162-3.2222-8.49374-3.1019-12.13253.2574-7.06117 7.5956-.344 8.4137 2.76434.3367 8.09894-1.8492 8.83774-5.3118z" fill="currentColor" id="path2"/><path d="m3.00152 13.9149c.34054-.2771.78266-.5279 1.33721-.743l.17291.5359.88014 1.0998 1.28927 1.153.9905-.145 4.95105-.5064 5.2045.5492c-.1637.515-.4287.9991-.7694 1.4477C15.5173 17.0017 11.9211 16.9114 9.96784 16.9078 9.44518 17.5136 9.25598 19.5736 9.2151 20.8038 9.17288 20.7999 9.1312 20.7954 9.09009 20.7904 8.54185 20.7236 8.00457 20.6134 7.48672 20.4672 7.43882 19.5053 7.77515 18.1299 8.01989 17.3664 6.48879 17.4486 4.86925 18.1947 3.97602 18.7145 3.56434 18.3884 3.20739 18.0402 2.91797 17.6812l1.98456-1.0757C4.59621 16.4519 3.62819 14.9452 3.00152 13.9149z" fill="currentColor" id="path3"/><path d="M16.8986 18.8203l1.7838 1.1899-8.0602 11.7636-1.9367-1.2919-1.48753-2.1642-.74485-3.5732 1.33387-3.1389 3.20141.9634z" fill="currentColor" id="path4"/><path fill-rule="evenodd" clip-rule="evenodd" d="M15.2758 11.0042c2.3911-5.0861403 8.2076-3.8391103 10.9546-2.0068003L18.6815 20.0147 17.8151 19.4368c-1.1 1.2586-3.3469 2.2113-4.3328 2.5303.1001 1.4145 1.3034 2.5052 1.8925 2.8737l-2.4801 3.6196c-2.89488-1.931-3.74047-4.6925-3.80141-5.8318l-1.0745-.0575c-1.89715 4.2428 1.07775 7.5309 2.91251 8.7548L7.72792 36.0012 8.28497 31.6116c-3.61109-3.0533-2.96504-7.6667-2.19063-9.5917C3.60654 21.5324-.71116398 17.9714.09996132 14.9451 1.51225 9.6757097 10.7796 9.7630597 15.2758 11.0042zm2.6538 4.4605c.5621-2.7545-5.4263-3.2044-8.49737-3.0844-1.95229.0414-3.45912.2662-4.5853.6176.50118 1.5357 1.66332 2.2994 2.22769 2.4976 3.56078-.7988 8.18428-.4303 10.85498-.0308zM17.705 16.192c-1.8625-.2387-4.6377-.3002-6.0775-.2966-1.95525 1.3169-2.20603 3.5377-2.03968 4.9319 2.64838.0449 6.94048-1.776 8.11718-4.6353zm-9.01016 4.5464c-.35729-2.0196.79278-3.9252 1.49856-4.7008-3.62095.1363-5.90362 1.15-7.01878 1.9457 1.19325 1.2879 3.24214 2.3888 5.52022 2.7551zM2.5405 17.15c.89512-.5396 2.4988-1.0361 3.3714-1.2581-1.26155-.9307-1.8124-1.9023-2.00718-2.5311-1.97331.9358-2.197 2.4008-1.36422 3.7892z" fill="#1a1a1a" id="path5"/><path fill-rule="evenodd" clip-rule="evenodd" d="m35.5569 8.0548297c-.4102-.35197-1.0318-.30931-1.3885.09529-.7042.79888-1.8771 1.54484-3.1462 2.1552803-1.2527.6024-2.4981 1.0253-3.2547 1.2163-.5265.1329-.844.6619-.7091 1.1814.1349.5195.6711.8329 1.1977.6999.8897-.2246 2.2604-.6937 3.6291-1.352 1.3521-.6503 2.8058-1.534 3.7687-2.6262703.3566-.4046.3132-1.01792-.097-1.3699z" fill="#1a1a1a" id="path6"/><path d="m23.2275 19.0151c2.385-1.5734 5.0488 3.7584 6.0825 6.621 4.2791 11.2045-4.5124 9.2957-7.785 3.4503-1.3468-2.4055-1.2788-8.1045 1.7025-10.0713z" fill="currentColor" id="path7"/><path d="m30.2594 32.1c.1337-.4151.2048-.9133.2005-1.5012L29.8914 30.6402 28.529 30.2441 26.9642 29.4933 26.7315 28.5324l-1.3687-4.7219L22.9067 19.25c-.4233.3418-.7798.7648-1.0748 1.2439.8604 1.297 2.2853 4.556 3.0167 6.343-.3751.7043-2.242 1.6452-3.3838 2.1411.0194.0372.0392.0737.0592.1095.2671.477.571.9279.9015 1.3475.9225-.3145 2.0908-1.135 2.7176-1.6436.4933 1.4325.3951 3.1933.2391 4.2049.4601.2554.9206.4525 1.3661.5837l.2722-2.2179c.2586.2232 2.0364.548 3.2389.7379z" fill="currentColor" id="path8"/><path d="m20.4651 21.1977-1.7838-1.1899-8.0602 11.7636 1.9367 1.2919 2.5898.5554 3.6382-.6495 2.4552-2.391-2.0992-2.5722z" fill="currentColor" id="path9"/><path fill-rule="evenodd" clip-rule="evenodd" d="M28.4238 19.774C32.3164 15.6893 28.976 10.8284 26.229 8.9960897L18.6802 20.0134l.8664.578c-.7738 1.4761-.8325 3.8884-.7651 4.9099-1.3678.4355-2.8419-.2597-3.4081-.6618l-2.48 3.6196c2.8948 1.931 5.8072 1.6761 6.9015 1.3073l.4544.9624c-3.2834 3.3181-7.4845 1.8196-9.3193.5958l-3.20344 4.6753 3.92084-2.1458c4.2173 2.1685 8.3155-.1422 9.8375-1.5687 1.3855 2.0962 6.3437 4.7225 8.8878 2.8521 4.4296-3.2567.8939-11.7094-1.9489-15.3635zm-5.1841-.7677c2.3812-1.5411 5.036 3.7742 6.0675 6.6308.6886 1.8029 1.0387 3.2663 1.1278 4.4284-1.6311.1134-2.7824-.666-3.1791-1.1089-.5757-3.5579-2.6452-7.6538-4.0162-9.9503zm-.6003.4767c.9185 1.6163 2.0106 4.1343 2.5437 5.4541-.51 2.2809-2.5052 3.3381-3.8784 3.7053-1.0291-2.4081-.916-7.0166 1.3347-9.1594zm-.9184 9.9439c2.0327-.4255 3.3963-2.1886 3.8628-3.1238 1.2211 3.3661 1.1184 5.8339.7856 7.1514-1.656-.6126-3.4549-2.0783-4.6484-4.0276zm5.6684 4.2977c.174-1.0207.0433-2.674-.073-3.5557 1.3454.8082 2.4645.9505 3.1284.8946-.1447 2.1554-1.4393 2.9062-3.0554 2.6611z" fill="#1a1a1a" id="path10"/></svg>
</span></span><span class=dark:text-neutral-300>La fonction <em>helper</em> <code>bpf_probe_read_user</code> permet de lire le contenu stock√© dans le pointeur depuis l&rsquo;espace utilisateur et de renvoyer une copie de sa valeur.</span></div><p>On a donc :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>argv1_deref</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bpf_probe_read_user</span><span class=p>(</span><span class=n>argv1</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Maintenant que <code>argv1_deref</code> est de structure <code>*const u8</code>, il faut le transformer en <code>&amp;str</code>. On se retrouve alors avec un code similaire √† la r√©cup√©ration du nom du binaire. √áa serait probablement utile de cr√©er une fonction pour un projet &ldquo;s√©rieux&rdquo;.</p><p>Voici le code complet pour r√©cup√©rer la premi√®re option :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>argv</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u8</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=n>arg</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=n>ok_or</span><span class=p>(</span><span class=mi>0</span><span class=k>u32</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w> </span><span class=c1>//arg1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=k>u8</span><span class=p>;</span><span class=w> </span><span class=mi>16</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>argname</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>argv1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w> </span><span class=c1>//arg1+8
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>argv1_deref</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bpf_probe_read_user</span><span class=p>(</span><span class=n>argv1</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w> </span><span class=c1>//*(arg1+8)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>argname_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bpf_probe_read_user_str_bytes</span><span class=p>(</span><span class=n>argv1_deref</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>from_utf8_unchecked</span><span class=p>(</span><span class=n>argname_bytes</span><span class=p>)</span><span class=w> </span><span class=c1>//str(*(arg1+8))
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;function execve called by libc {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>argname</span><span class=p>);</span><span class=w> </span><span class=c1>//printf(&#34;%s\n&#34;, str(*(arg1+8)));
</span></span></span></code></pre></div><div class="flex px-4 py-3 rounded-md
alert-info"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-info"><span class="relative block icon"><svg id="a" viewBox="0 0 58.530809 60.557009" width="58.530807" height="60.557011"><path d="m57.75 8.16701c-.59-.44-1.33-.55-2.05-.6-4.36-.28-8.74 1.67-11.44 5.08-.43.54-.93 1.06-1.42.89-.5-.17-.55-.94-.54-1.59.06-4.38-2.25-8.8-5.87-11.24999999-.62-.42-1.63-.84-2.47-.65-.4.1-.73.33-.93.68C32.24 2.10701 34.05 3.41701 34.82 3.96701c2.39 1.73 3.94 4.64 4.05 7.59.0.22.0.43-.09.58-.16.25-.53.29-.9.33h-.09c-2.16.23-4.17 1.54-5.25 3.44-1.01 1.8-1.15 4.04-.38 5.95-6.64.62-13.49 1.76-18.83 5.59-1.83 1.31-3.11 2.75-3.8 4.28-.22.48-.38.96-.48 1.49-.45 2.28.43 4.78 2.25 6.37 1.75 1.51 4.28 2.12 6.61 1.58l.33-.08c.78-.2 1.59-.4 2.17.0.47.32.65.95.81 1.61l3.63 14.65c.25 1.01.71 2.39 1.89 2.65.14.03.27.05.4.05.77.0 1.49-.5 2.12-.99l11.46-8.99c.69-.55 1.43-1.07 2.21-.97.79.1 1.33.78 1.89 1.51.14.18.28.36.42.52 1.67 2 4.48 2.93 7.01 2.33 1.29-.31 2.48-1 3.44-2.01 1.04-1.08 1.68-2.34 1.79-3.47.1-1.28-.01-2.69-.33-4.2-.52-2.56-1.61-5.14-3.23-7.69-2.23-3.5-5.16-6.48-8.02-9.36 1.82-1 3.13-2.84 3.47-4.88.35-2.17-.4-4.46-1.98-6-.27-.26-.58-.56-.54-.86.02-.16.15-.31.28-.45 2.06-2.32 5.25-3.63 8.35-3.41.95.07 2.4.18 2.91-.88.37-.73-.04-1.63-.64-2.08zm-20.25 20.39.15.06.02-.02c2.33.9 4.04 3.14 4.68 6.17.06.24-.02.49-.21.66-.18.17-.44.23-.68.16-1.81-.51-3.75-1.13-5.76-1.84h-.07c-2.06-.76-3.9-1.48-5.6-2.21-.23-.09-.39-.3-.42-.55-.04-.25.06-.49.25-.64 2.46-1.99 5.25-2.63 7.64-1.79zm-13.31 2.93-.05.05c-.32.48-.63 1-.93 1.5-.92 1.54-1.88 3.14-3.38 4.05-1.34.81-3.01 1.01-4.6.56-1.09-.32-1.97-.92-2.45-1.69-.48-.77-.58-1.59-.3-2.43.83-2.43 4.81-4.69 7.13-5.55 2.11-.79 4.37-1.26 6.55-1.72.69-.15 1.37-.29 2.05-.44l.18-.04c.99-.23 2.01-.46 3.01-.46.02.0.05.0.07.01-2.19.95-4.2 2.41-5.85 4.29-.56.63-1.05 1.27-1.43 1.87zm13.89 16.45c-2.04 1.82-4.35 3.19-5.97 4.03-.79-.41-1.6-.77-2.4-1.05-.82-.29-1.68-.53-2.71-.74-.73-1.67-1.67-4.19-2.11-6.92-.02-.15.07-.24.11-.27s.15-.1.3-.03c2.07.88 4.16 1.71 6.23 2.45h.07c2.03.74 4.17 1.42 6.35 2.03.16.05.2.17.22.23.01.05.02.17-.09.27zm4.33-7.56c-.12.79-.35 1.64-.69 2.6-.08.25-.19.52-.31.77-.23.5-.82.77-1.36.63h-.04c-2.34-.63-4.78-1.39-7.27-2.27l-.07-.02c-2.52-.9-4.9-1.85-7.05-2.83-.51-.23-.79-.81-.66-1.35.05-.24.13-.51.24-.78.33-.94.69-1.74 1.11-2.46.23-.43.75-.61 1.2-.4 2.24 1 4.6 1.93 7 2.78h.07c2.39.87 4.79 1.63 7.15 2.26.48.13.78.59.68 1.07zm4-8.18.08.11c.42.54.86 1.07 1.29 1.6 1.41 1.75 2.88 3.55 4.03 5.51.9 1.53 3.03 6.1 2.03 8.8-.31.83-.9 1.4-1.76 1.69-.87.3-1.92.22-2.97-.23-1.49-.64-2.69-1.88-3.21-3.33-.6-1.67-.33-3.52-.08-5.31.09-.58.17-1.16.22-1.74.08-.73.1-1.51.06-2.4-.1-2.5-.73-4.91-1.85-7.04.82.64 1.5 1.5 2.16 2.34zm-.52-11.58c-.19 1.81-1.66 3.58-3.5 4.22l-.2.06c-1.77.55-3.61.22-4.96-.89-1.67-1.38-2.36-3.88-1.64-5.96.64-1.83 2.03-2.36 3.44-2.36.97.0 1.95.25 2.69.51 1.92.66 4.43 1.84 4.17 4.42zm-35.71 33.98h8.71c.97.0 1.76-.79 1.76-1.76s-.79-1.75-1.76-1.75h-8.71c-.97.0-1.76.79-1.76 1.75s.79 1.76 1.76 1.76zm11.69 2.45H1.75c-.97.0-1.75.79-1.75 1.76s.78 1.75 1.75 1.75h20.12c.96.0 1.75-.79 1.75-1.75s-.79-1.76-1.75-1.76z" style="fill:currentColor" id="path9"/></svg>
</span></span><span class=dark:text-neutral-300>En commentaire j&rsquo;ai mis le code √©quivalent avec <code>bpftrace</code>.</span></div><h3 class="relative group">Testons maintenant la modification<div id=testons-maintenant-la-modification-1 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#testons-maintenant-la-modification-1 aria-label=Ancre>#</a></span></h3><p>V√©rifions que le code fonctionne toujours :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nv>RUST_LOG</span><span class=o>=</span>info <span class=nf>cargo</span> run
</span></span></code></pre></div><p>Sur un autre terminal, lan√ßons une commande avec une option :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nf>ls</span> <span class=na>-lrt</span>
</span></span></code></pre></div><p>Sur le terminal <code>cargo run</code> vous verrez :</p><pre tabindex=0><code>[INFO  test_uprobe_2] function execve called by libc /usr/bin/ls
[INFO  test_uprobe_2] function execve called by libc -lrt
</code></pre><p>C&rsquo;est le comportement qu&rsquo;on voulait.</p><p>Si on lance une commande sans option que se passe-t-il ?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fish data-lang=fish><span class=line><span class=cl><span class=nf>man</span>
</span></span></code></pre></div><p>Sur le terminal <code>cargo run</code> vous ne verrez que :</p><pre tabindex=0><code>[INFO  test_uprobe_2] function execve called by libc /usr/bin/man
</code></pre><p>Que s&rsquo;est-il pass√© ?</p><p>Cette partie du code ne s&rsquo;est pas affich√©e :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=fm>info!</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;function execve called by libc {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>argname</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Comme la commande n&rsquo;a pas d&rsquo;argument, cette partie du code est partie en erreur :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Rust data-lang=Rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>argname</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>argv1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=p>.</span><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w> </span><span class=c1>//arg1+8
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>argv1_deref</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=kt>u8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bpf_probe_read_user</span><span class=p>(</span><span class=n>argv1</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w> </span><span class=c1>//*(arg1+8)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>argname_bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bpf_probe_read_user_str_bytes</span><span class=p>(</span><span class=n>argv1_deref</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>buf</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>from_utf8_unchecked</span><span class=p>(</span><span class=n>argname_bytes</span><span class=p>)</span><span class=w> </span><span class=c1>//str(*(arg1+8))
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>Et donc le programme est parti en erreur et n&rsquo;a jamais parcouru le dernier <code>info</code>.</p><div class="flex px-4 py-3 rounded-md
alert-tip"><span class="ltr:pr-3 rtl:pl-3 flex items-center
alert-icon-tip"><span class="relative block icon"><!doctype html><svg height="800" width="800" id="_x32_" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><style>.st0{fill:currentColor}</style><g><path class="st0" d="M485.235 281.91l-44.273-25.356-65.345 8.26c-1.168-4.886-2.55-9.608-4.173-14.099l46.634-18.049 27.349-47.596-2.954-23.279c18.874-15.396 31.677-45.767 16.762-78.388-18.024-39.422-54.964-47.27-54.964-47.27l2.07 70.755-56.364-28.259c-5.169 72.541 40.787 95.467 69.029 93.252l1.031 8.098-18.917 32.912-40.512 15.688c-13.516-20.728-36.811-43.303-38.589-58.287 5.144-4.336 8.407-10.82 8.407-18.075.0-13.051-10.578-23.631-23.63-23.631s-23.64 10.58-23.64 23.631c0 6.475 2.611 12.34 6.818 16.607-7.007 10.501-6.414 17.723-33.978 17.723-27.555.0-26.97-7.222-33.977-17.723 4.216-4.267 6.826-10.132 6.826-16.607.0-13.051-10.588-23.631-23.648-23.631-13.052.0-23.622 10.58-23.622 23.631.0 7.256 3.263 13.739 8.406 18.075-1.777 14.984-25.073 37.558-38.588 58.287l-40.521-15.688-18.9-32.912 1.022-8.098c28.242 2.215 74.198-20.711 69.021-93.252l-56.364 28.259 2.078-70.755s-36.948 7.849-54.963 47.27c-14.924 32.62-2.113 62.992 16.752 78.388l-2.954 23.279 27.348 47.596 46.635 18.049c-1.606 4.491-2.998 9.213-4.174 14.099l-65.336-8.26L26.756 281.91.0 327.935l15.353 10.158 28.671-37.773 32.088-18.376 56.596 7.162c-.293 4.259-.404 8.518-.301 12.786l-40.71 13.567L52.216 362.84l-6.414 60.279 18.195 2.868 11.42-52.628 30.672-36.811 29.478-9.832c2.216 9.223 5.634 17.929 10.45 25.64l-27.624 19.174-11.867 51.546 15.903 52.791 17.774-4.808-8.569-49.176 9.247-36.064 20.574-14.28c34.467 33.874 81.737 33.643 94.539 33.643 12.812.0 60.073.231 94.549-33.643l20.574 14.28 9.239 36.064-8.56 49.176 17.774 4.808 15.903-52.791-11.876-51.546-27.632-19.174c4.826-7.711 8.244-16.418 10.458-25.64l29.479 9.832 30.68 36.811 11.412 52.628 18.195-2.868-6.414-60.279-39.482-47.381-40.71-13.567c.112-4.267-.009-8.526-.292-12.786l56.595-7.162 32.081 18.376 28.67 37.773L512 327.935 485.235 281.91z"/></g></svg>
</span></span><span class=dark:text-neutral-300>La r√©cup√©ration des variables d&rsquo;environnement de la commande est tr√®s similaire vu qu&rsquo;il est du m√™me type que pour les arguments.</span></div><hr><p>Cet √©pisode est maintenant termin√© ! Nous avons vu comment r√©cup√©rer les arguments d&rsquo;une fonction d&rsquo;un programme en C notamment pour des cha√Ænes de caract√®res et des tableaux de cha√Ænes de caract√®re et comment les afficher.</p><p>Dans le prochain √©pisode, nous allons voir comment profiler une fonction d&rsquo;un programme.</p></div><details class="mt-2 mb-5 overflow-hidden rounded-lg ltr:ml-0 ltr:pl-5 rtl:mr-0 rtl:pr-5"><summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">Apprenons uProbe avec eBPF et Aya -
Cet article fait partie d'une s√©rie.</summary><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=/ebpf-another-type/uprobe/intro/>Partie 1:
L‚Äôobservabilit√© pour tous les d√©veloppeurs avec les uProbes</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=/ebpf-another-type/uprobe/example-1/>Partie 2:
Observons une fonction simple de ton programme avec des uProbes</a></div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">Partie 3:
Cet article</div><div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><a href=/ebpf-another-type/uprobe/example-3-tr/>Partie 4:
Profilons un petit programme avec des uProbes</a></div></details><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/&amp;title=Sondons%20une%20biblioth%c3%a8que%20avec%20une%20uProbe" title="Poster sur LinkedIn" aria-label="Poster sur LinkedIn"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://bsky.app/intent/compose?text=Sondons%20une%20biblioth%c3%a8que%20avec%20une%20uProbe+https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/" title aria-label><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span>
</a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://s2f.kytta.dev/?text=Sondons%20une%20biblioth%c3%a8que%20avec%20une%20uProbe%20https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/" title aria-label><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://blog.littlejo.link/ebpf-another-type/uprobe/example-2/&amp;subject=Sondons%20une%20biblioth%c3%a8que%20avec%20une%20uProbe" title="Envoyer par email" aria-label="Envoyer par email"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_ebpf-another-type/uprobe/example-2/index.md data-oid-likes=likes_ebpf-another-type/uprobe/example-2/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/ebpf-another-type/uprobe/example-1/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Observons une fonction simple de ton programme avec des uProbes</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-09-15T10:35:33+02:00>15 septembre 2025</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/ebpf-another-type/uprobe/example-3-tr/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Profilons un petit programme avec des uProbes</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-09-23T09:15:14+02:00>23 septembre 2025</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0 z-10"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Faire d√©filer jusqu'au bas de la page" title="Faire d√©filer jusqu'au bas de la page">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/tags/ title=Tags>Tags</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Joseph Ligier</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom):not(a > img)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://blog.littlejo.link/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Rechercher tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Fermer (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>